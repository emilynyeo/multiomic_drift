---
title: "Paper plots for render"
author: "Emily Yeo"
date: "`r Sys.Date()`"
output: 
  officedown::rdocx_document:
    #reference_docx: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.cap = TRUE)
```

## LOAD 

```{r include=FALSE}
rm(list = ls())
#source("zc_functions.R") 
#install.packages("rsq")  
library(pacman)
p_load(tools, reticulate, viridis, tidyplots, patchwork, jsonlite, maps, ggvenn, 
       caret, caretEnsemble, glmnet, xgboost, ggplot2, glmmLasso, corrplot,
       readr, plyr, dplyr, tidyr, purrr, tibble, stringr, psych, randomForest,  
       reshape2, scales, gridExtra, plotly, sf, tidyverse, naniar, VIM, gridExtra,
       sjPlot, htmltools, officer, flextable, webshot, apaTables, MuMIn, lme4, 
       glue, grid, rsq, pheatmap, GGally, VennDiagram, glmmTMB, broom.mixed, gt,
       pathcwork)
#library(nlme)

'%ni%' <- Negate('%in%')
r2_general <-function(preds,actual){ 
  return(1- sum((preds - actual) ^ 2)/sum((actual - mean(actual))^2))
}
q_squared <- function(actual, predicted) {
  ss_res <- sum((actual - predicted)^2)
  ss_tot <- sum((actual - mean(actual))^2)
  1 - (ss_res / ss_tot)
}

geom_top_rounded_rect <- function(mapping = NULL, data = NULL,
                                       stat = "identity", position = "identity",
                                       radius = grid::unit(6, "pt"),
                                       ...,
                                       na.rm = FALSE,
                                       show.legend = NA,
                                       inherit.aes = TRUE) {
  layer(
    data = data,
    mapping = mapping,
    stat = stat,
    geom = GeomTopRoundedRect,
    position = position,
    show.legend = show.legend,
    inherit.aes = inherit.aes,
    params = list(
      radius = radius,
      na.rm = na.rm,
      ...
    )
  )
}

GeomTopRoundedRect <- ggplot2::ggproto(
  "GeomTopRoundedRect", ggplot2::Geom,

  default_aes = ggplot2::aes(
    colour = NA, fill = "grey35", size = 0.5, linetype = 1, alpha = NA
  ),

  required_aes = c("xmin", "xmax", "ymin", "ymax"),

  draw_panel = function(self, data, panel_params, coord,
                        radius = grid::unit(6, "pt")) {

    coords <- coord$transform(data, panel_params)

    grobs <- lapply(1:length(coords$xmin), function(i) {
        
      gridGeometry::polyclipGrob(
        grid::roundrectGrob(
          coords$xmin[i], coords$ymax[i],
          width = (coords$xmax[i] - coords$xmin[i]),
          height = (coords$ymax[i] - coords$ymin[i]),
          r = radius,
          default.units = "native",
          just = c("left", "top")
        ),
        grid::rectGrob(
          coords$xmin[i], coords$ymax[i] - (coords$ymax[i] - coords$ymin[i]) / 2,
          width = (coords$xmax[i] - coords$xmin[i]),
          height = (coords$ymax[i] - coords$ymin[i]) / 2,
          default.units = "native",
          just = c("left", "top")
        ),
        op = "union",
        gp = grid::gpar(
          col = coords$colour[i],
          fill = alpha(coords$fill[i], coords$alpha[i]),
          lwd = coords$size[i] * .pt,
          lty = coords$linetype[i],
          lineend = "butt"
        )
      )
    })

    grobs <- do.call(grid::gList, grobs)
    ggplot2:::ggname("geom_top_rounded_rect", grid::grobTree(children = grobs))
  },
  draw_key = ggplot2::draw_key_polygon)

geom_top_rounded_col <- function(mapping = NULL, data = NULL,
                          position = ggplot2::position_stack(reverse = TRUE),
                          radius = grid::unit(3, "pt"), ..., width = NULL,
                          na.rm = FALSE, show.legend = NA, inherit.aes = TRUE) {
  layer(
    data = data, mapping = mapping, stat = "identity",
    geom = GeomTopRoundedCol, position = position, show.legend = show.legend,
    inherit.aes = inherit.aes, params = list(
      width = width, radius = radius, na.rm = na.rm, ...
    )
  )
}

GeomTopRoundedCol <- ggproto(
  "GeomTopRoundedCol", GeomTopRoundedRect,
  required_aes = c("x", "y"),

  setup_params = function(data, params) {
    params$flipped_aes <- has_flipped_aes(data, params)
    params
  },
  non_missing_aes = c("xmin", "xmax", "ymin", "ymax"),
  setup_data = function(data, params) {
    data$width <- data$width %||%
      params$width %||% (resolution(data$x, FALSE) * 0.9)
    transform(data,
              ymin = pmin(y, 0), ymax = pmax(y, 0),
              xmin = x - width / 2, xmax = x + width / 2, width = NULL
    )
  },
  draw_panel = function(self, data, panel_params, coord, width = NULL, radius = grid::unit(3, "pt")) {
    ggproto_parent(GeomTopRoundedRect, self)$draw_panel(data, panel_params, coord, radius = radius)
  }
)

```

```{r include=FALSE}
# ANOVA & Feat Imp Comparisons 
omic_out_dir <- "/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/april/anova_results/plots/paper_render/basic_plus_diet/"
venn_dir <- "/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/april/anova_results/plots/venn/"
# MERF LONG 
#predict_dir <- "/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/april/final_merf_dfs"
#pred_dir_long <- "/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/april/new_split"
pred_dir_long <- "/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/may_basic_plus/long"
#merf_long <- read.csv('/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/april/anova_results/new_split/april_long_predictions_df_april29.csv') %>% 
merf_long <- read.csv('/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/may_basic_plus/long/merf_long_predictions_df.csv') %>%  
             dplyr::filter(Model == "MSE Model")

basic <- read.csv(file.path(pred_dir_long, "basic_long.csv")) %>% dplyr::rename(y_new_basic = y_hat_new)
meta <- read.csv(file.path(pred_dir_long, "meta_keep_long.csv")) %>% dplyr::rename(y_new_meta = y_hat_new)
grs <- read.csv(file.path(pred_dir_long, "only_grs_long.csv")) %>% dplyr::rename(y_new_grs = y_hat_new)
taxa <- read.csv(file.path(pred_dir_long, "only_taxa_long.csv")) %>% dplyr::rename(y_new_taxa = y_hat_new)
pathway <- read.csv(file.path(pred_dir_long, "only_pathway_long.csv")) %>% dplyr::rename(y_new_pathway = y_hat_new)
micom <- read.csv(file.path(pred_dir_long, "only_micom_long.csv")) %>% dplyr::rename(y_new_micom = y_hat_new)
metabo <- read.csv(file.path(pred_dir_long, "only_metabo_long.csv")) %>% dplyr::rename(y_new_metabo = y_hat_new)
all <- read.csv(file.path(pred_dir_long, "only_all_long.csv")) %>% dplyr::rename(y_new_all = y_hat_new)

# MERF DELTA
merf_delta <- read.csv('/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/may_basic_plus/delta/merf_delta_predictions_df.csv') %>% 
              dplyr::filter(Model == "MSE Model")
predict_dir <- "/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/may_basic_plus/"
basic_md <- read.csv(file.path(predict_dir, "basic_delta_april29.csv")) %>% dplyr::rename(y_new_basic = y_hat_new)
meta_md <- read.csv(file.path(predict_dir, "meta_keep_delta_april29.csv")) %>% dplyr::rename(y_new_meta = y_hat_new)
grs_md <- read.csv(file.path(predict_dir, "only_grs_delta_april29.csv")) %>% dplyr::rename(y_new_grs = y_hat_new)
taxa_md <- read.csv(file.path(predict_dir, "only_taxa_delta_april29.csv")) %>% dplyr::rename(y_new_taxa = y_hat_new)
pathway_md <- read.csv(file.path(predict_dir, "only_pathway_delta_april29.csv")) %>% dplyr::rename(y_new_pathway = y_hat_new)
micom_md <- read.csv(file.path(predict_dir, "only_micom_delta_april29.csv")) %>% dplyr::rename(y_new_micom = y_hat_new)
metabo_md <- read.csv(file.path(predict_dir, "only_metabo_delta_april29.csv")) %>% dplyr::rename(y_new_metabo = y_hat_new)
all_md <- read.csv(file.path(predict_dir, "only_all_delta_april29.csv")) %>% dplyr::rename(y_new_all = y_hat_new)

# GLMMLASSO LONG
#gl_lasso_long <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/march30_long/new_split_may/april_long_predictions_df_april29.csv") %>% 
gl_lasso_long <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/long/june_lasso_long_predictions_df.csv") %>%
   dplyr::rename(y_new_meta = y_new_meta_only,
                 y_new_grs = y_new_grs_only,
                 y_new_taxa = y_new_tax_only,
                 y_new_micom = y_new_micom_only,
                 y_new_pathway = y_new_path_only,
                 y_new_metabo = y_new_metabo_only,
                 y_new_all = y_new_all_only)

gl_ftimp_long_basic <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/long/may_basic_plusbasic_gl_long_top_features.csv")
gl_ftimp_long_meta <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/long/may_basic_plusmeta_gl_long_top_features.csv")
gl_ftimp_long_grs <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/long/grs_gl_long_top_features.csv")
gl_ftimp_long_taxa <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/long/may_basic_plustaxa_gl_long_top_features.csv")
gl_ftimp_long_micom <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/long/may_basic_plusmicom_gl_long_top_features.csv")
gl_ftimp_long_pathway <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/long/may_basic_pluspathway_gl_long_top_features.csv")
gl_ftimp_long_metabo <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/long/may_basic_plusmetabo_gl_long_top_features.csv")
gl_ftimp_long_all <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/long/may_basic_plusall_gl_long_top_features.csv")

# GLMMLASSO DELTA 
gl_lasso_delta <- read.csv('/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/delta/gl_delta_predictions_df.csv') %>% 
   dplyr::rename(y_new_basic = y_new_basic_only,
                 y_new_meta = y_new_meta_only,
                 y_new_grs = y_new_grs_only,
                 y_new_taxa = y_new_tax_only,
                 y_new_micom = y_new_micom_only,
                 y_new_pathway = y_new_path_only,
                 y_new_metabo = y_new_metab_only,
                 y_new_all = y_new_all_only)

gl_ftimp_delta_basic <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/delta/basic_gl_delta_top_features.csv")
gl_ftimp_delta_meta <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/delta/meta_gl_delta_top_features.csv")
gl_ftimp_delta_grs <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/delta/grs_gl_delta_top_features.csv")
gl_ftimp_delta_taxa <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/delta/taxa_gl_delta_top_features.csv")
gl_ftimp_delta_micom <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/delta/micom_gl_delta_top_features.csv")
gl_ftimp_delta_pathway <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/delta/pathway_gl_delta_top_features.csv")
gl_ftimp_delta_metabo <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/delta/metabo_gl_delta_top_features.csv")
gl_ftimp_delta_all <- read.csv("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/glmmlasso/may_basic_plus/delta/all_gl_delta_top_features.csv")
```

# Rename top 20 features 

```{r}
gl_ftimp_delta_meta <- gl_ftimp_delta_meta %>%
  dplyr::mutate(
    Feature = dplyr::recode(
      Feature,
      "Ldl" = "LDL",
      "Randomized group1" = "IMF Diet Grp.",
      "Sex" = "Sex (Male)",
      "Hdl" = "HDL",
      "Glucose" = "Glucose x",
      "Homo ir" = "Homo-IR"))

gl_ftimp_delta_pathway <- gl_ftimp_delta_pathway %>%
  dplyr::mutate(
    Feature = dplyr::recode(
      Feature,
      "Superpathway of sulfolactate degradation" = "Sulfolactate degr.",
                "Superpathway of l phenylalanine biosynthesis" = "L-Phe biosynthesis",
                "Urate biosynthesis inosine 5  Phosphate degradation" = "Urate-IMP pathway",
                "Isoprene biosynthesis ii Engineered" = "Isoprene biosynth. II",
                "Mixed acid fermentation" = "Mixed acid ferm.",
                "Tca cycle vii Acetate producers" = "TCA VII (acetate)",
                "Hexitol fermentation to lactate Formate Ethanol and acetate" = "Hexitol → Lac/For/Eth/Ace",
                "Superpathway of R r Butanediol biosynthesis" = "(R,R)-Butanediol biosynth.",
                "Heme biosynthesis ii Anaerobic" = "Heme biosynth. II (anaerobic)"))

gl_ftimp_delta_metabo <- gl_ftimp_delta_metabo %>%
  dplyr::mutate(
    Feature = dplyr::recode(
      Feature,
      "Ldl" = "LDL",
      "Glyca" = "Glycoprotein acetyls",
      "Vldl size" = "VLDL-size",
      "Hdl size" = "HDL-size",
      "Gly" = "Glycine",
      "Vldl tg" = "TGs in VLDL",
      "Tg by pg" = "TGs/Phosphoglycerides",
      "Dha pct" = "DHA (% of FAs)",
      "Vldl l" = "Lipids in VLDL"))

gl_ftimp_delta_all <- gl_ftimp_delta_all %>%
  dplyr::mutate(
    Feature = dplyr::recode(
      Feature,
      "Superpathway of sulfolactate degradation" = "Sulfolactate degr.",
      "Superpathway of l phenylalanine biosynthesis" = "L-Phe biosynthesis",
      "Ldl" = "LDL",
      "Glyca" = "Glycoprotein acetyls",
      "Vldl size" = "VLDL-size",
      "Hdl size" = "HDL-size",
      "Gly" = "Glycine",
      "Vldl tg" = "TGs in VLDL",
      "Tg by pg" = "TGs/Phosphoglycerides",
      "Dha pct" = "DHA (% of FAs)",
      "Vldl l" = "Lipids in VLDL"))

gl_ftimp_long_meta <- gl_ftimp_long_meta %>%
  dplyr::mutate(
    Feature = dplyr::recode(
      Feature,
      "Ldl" = "LDL",
      "Randomized group1" = "IMF Diet Grp.",
      "Sex" = "Sex (Male)",
      "Hdl" = "HDL",
      "Glucose" = "Glucose x",
      "Homo ir" = "Homo-IR"))

gl_ftimp_long_metabo <- gl_ftimp_long_metabo %>%
  dplyr::mutate(
    Feature = dplyr::recode(
      Feature,
      "Ldl" = "LDL",
      "Glyca" = "Glycoprotein acetyls",
      "Bohbutyrate" = "3-Hydroxybutyrate",
      "Ldl size" = "LDL-size",
      "Hdl size" = "HDL-size",
      "Gly" = "Glycine",
      "Gln" = "Glutamine",
      "Vldl tg" = "TGs in VLDL",
      "Tg by pg" = "TGs/Phosphoglycerides",
      "Dha pct" = "DHA (% of FAs)",
      "Vldl l" = "Lipids in VLDL"))
```


# Merf features 
```{r}
omic_parsed <- pathway %>%
      mutate(Top_15_Feature_Importances = gsub("'", '"', Top_15_Feature_Importances)) %>%
      mutate(parsed = map(Top_15_Feature_Importances, fromJSON))
    
omic_long <- omic_parsed %>%
      unnest(parsed) %>%
      dplyr::select(-Top_15_Feature_Importances) %>%
      filter(Feature != "time")
    
avg_importance <- omic_long %>%
      group_by(Feature) %>%
      summarise(avg_importance = mean(Importance, na.rm = TRUE), .groups = "drop") %>%
      #plyr::mutate(Feature = reorder(Feature, avg_importance)) %>%
      slice_max(order_by = avg_importance, n = 10, with_ties = FALSE) %>%
      head(20)

avg_importance
```

# Merf feature conversions
```{r}
library(jsonlite)
library(purrr)
library(dplyr)

# Define a renaming dictionary
feature_rename_meta <- c(
  "Triglyceride_lipid" = "TG",
  "HDL_Total_Direct_lipid" = "HDL",
  "LDL_Calculated" = "LDL",
  "Glucose.x" = "Glucose",
  "Insulin_endo" = "Insulin",
  "HOMA_IR" = "Homo-IR",
  "race" = "Race",
  "age" = "Age",
  "sex" = "Sex (Male)",
  "randomized_group" = "IMF Diet Grp.")

feature_rename_metabo <- c(
  "GlycA" = "Glycoprotein Acetyls",
  "DHA_pct" = "DHA (% of FAs)",
  "Gly" = "Glycine",
  "Ala" = "Alanine",
  "Glucose.y" = "Glucose",
  "Gln" = "Glutamine-IR",
  "HDL_CE" = "Chol. esters in HDL",
  "DHA_pct" = "DHA (% of FAs)",
  "IDL_CE_pct" = "Cholesteryl Esters (% of IDL Lipids)",
  "PUFA_pct" = "PUFA (%)",
  "HDL_size" = "HDL-size",
  "VLDL_TG" = "TGs in VLDL",
  "LA" = "Linoleic Acid (% of FAs)")

feature_rename_taxa <- c(
  "g__Anaerobutyricum" = "G Anaerobutyricum",
  "g__Anaerotignum_189125" = "G Anaerotignum 189125",
  "g__CAG-127" = "G CAG-127",
  "g__Clostridium_Q_135822" = "G Clostridium Q 135822",
  "g__Collinsella" = "G Collinsella",
  "g__Coprenecus" = "G Coprenecus",
  "g__Dorea_A" = "G Dorea A",
  "g__Enterocloster" = "G Enterocloster",
  "g__Eubacterium_I" = "G Eubacterium I",
  "g__Faecalibacillus" = "G Faecalibacillus",
  "g__Faecousia" = "G Faecousia",
  "g__Frisingicoccus" = "G Frisingicoccus",
  "g__Haemophilus_D_735815" = "G Haemophilus D 735815",
  "g__Holdemanella" = "G Holdemanella",
  "g__Lawsonibacter" = "G Lawsonibacter",
  "g__Acetatifactor" = "G Acetatifactor",
  "g__Agathobacter_164117" = "G Agathobacter 164117",
  "g__Agathobaculum" = "G Agathobaculum",
  "g__Akkermansia" = "G Akkermansia",
  "g__Alistipes_A_871400" = "G Alistipes A 871400",
  "g__BX12" = "G BX12",
  "g__Bifidobacterium_388775" = "G Bifidobacterium 388775",
  "g__CAG-127" = "G CAG-127",
  "g__CAG-274" = "G CAG-274",
  "g__Clostridium_Q_135822" = "G Clostridium Q 135822",
  "g__Collinsella" = "G Collinsella",
  "g__Coprococcus_A_187866" = "G Coprococcus A 187866",
  "g__Copromonas" = "G Copromonas",
  "g__Eggerthella" = "G Eggerthella",
  "g__Eisenbergiella" = "G Eisenbergiella",
  "g__Streptococcus" = "G Streptococcus",
  "g__UBA1417" = "g__UBA1417",
  "g__Intestinibacter" = "G Intestinibacter",
  "g__Ruminiclostridium_E" = "G Ruminiclostridium E",
  "g__Ruminococcus_D" = "G Ruminococcus D", 
  "g___1" = "G 1",
  "g__Porcincola" = "G Porcincola",
  "g__Ruminococcus_C_58660" = "G Ruminococcus C58660",
  "g__Longicatena" = "G Longicatena",
  "g__Ruminococcus_D" = "G Ruminococcus D",
  "g__Marvinbryantia" = "G Marvinbryantia"
  )

feature_rename_pathway <- c(
  "D.glucarate.degradation.I" = "D-glucarate degr. ",
  "L.lysine.biosynthesis.II" = "L-lysine biosyn. II",
  "L.lysine.fermentation.to.acetate.and.butanoate" = "Lys ferm. to acetate/butanoate",
  "L.rhamnose.degradation.I" = "L-rhamnose degr. I",
  "TCA.cycle.VI..obligate.autotrophs. " = "TCA VI (autotrophs)",
  "aromatic.biogenic.amine.degradation..bacteria." = "Aromatic amine degr. (bacteria)",
  "glucose.and.glucose.1.phosphate.degradation" = "Glucose/G1P degr.",
  "incomplete.reductive.TCA.cycle" = "Incomplete reductive TCA",
  "isoprene.biosynthesis.II..engineered." = "Isoprene biosynth. II (eng.)",
  "isopropanol.biosynthesis" = "Isopropanol biosyn.",
  "Bifidobacterium.shunt" = "Bifidobacterium shunt",
  "GDP.mannose.biosynthesis" = "GDP mannose biosyn.",
  "L.histidine.degradation.I" = "L-hist. degr.I ",
  "UDP.2.3.diacetamido.2.3.dideoxy..alpha..D.mannuronate.biosynthesis" = "UDP-DDDA-ManA biosyn.",
  "X1.4.dihydroxy.6.naphthoate.biosynthesis.I " = "1,4 dihydroxy naphthoate biosyn.I",
  "X1.4.dihydroxy.6.naphthoate.biosynthesis.II" = "1,4 dihydroxy naphthoate biosyn.II",
  "allantoin.degradation.to.glyoxylate.III" = "Allantoin → Glyoxylate III",
  "arginine..ornithine.and.proline.interconversion" = "Arg–Orn–Pro interconversion",
  "glycolysis.V..Pyrococcus." = "Glycolysis V Pyro.",
  "heme.biosynthesis.II..anaerobic." = "heme biosyn.II anaerobic",
  "lactose.and.galactose.degradation.I" = "lactose/galactose degr.I",
  "pyrimidine.deoxyribonucleotides.de.novo.biosynthesis.II" = "Pyr dNTP biosyn.II",
  "hexitol.fermentation.to.lactate..formate..ethanol.and.acetate" = "Hexitol Fermentation",
  "X4.deoxy.L.threo.hex.4.enopyranuronate.degradation" = "deoxy enopyranuronate degr.",
  "TCA.cycle.VI..obligate.autotrophs." = "TCA VI obligate autotrophs",
  "reductive.acetyl.coenzyme.A.pathway" = "Red. Acetyl-CoA Pathway",
  "superpathway.of.sulfur.oxidation..Acidianus.ambivalens." = "Acidianus Ambivalens (Sulfur Oxi.)",
  "peptidoglycan.biosynthesis.V...beta..lactam.resistance." = "Peptidoglycan Biosyn.V",
  "superpathway.of.2.3.butanediol.biosynthesis" = "2,3 Butanediol Biosynthesis Pathways",
  "superpathway.of..R.R..butanediol.biosynthesis" = "R,R Butanediol Biosynthesis Pathway",
  "NAD.salvage.pathway.II" = "NAD Salvage Pathway II",
  "inosine.5..phosphate.biosynthesis.III" = "Inosine-5-phosphate Biosyn.III",
  "fatty.acid.salvage" = "Fatty Acid Salvage",
  "ketogluconate.metabolism" = "Ketogluconate Metabolism",
  "superpathway.of.sulfolactate.degradation" = "Sulfolactate Degradation Pathways", 
  "superpathway.of.UDP.N.acetylglucosamine.derived.O.antigen.building.blocks.biosynthesis" = "UDPN Acetylglucosamine-O-antigen Biosyn.",
  "mono.trans..poly.cis.decaprenyl.phosphate.biosynthesis" = "Mono-trans-poly-cis-decaprenyl-phosphate Biosyn.",
  "thiazole.biosynthesis.II..Bacillus." = "Thiazole Biosyn.II Bacillus.",
  "L.histidine.degradation.II" = "L-histidine Degradation II",
  "superpathway.of.L.phenylalanine.biosynthesis" = "L-phenylalanine Biosyn. Pathways",
  "superpathway.of.hexitol.degradation..bacteria." = "Bacterial Hexitol Degradation Pathways",
  "UDP.2.3.diacetamido.2.3.dideoxy..alpha..D.mannuronate.biosynthesis" = "UDP-DDDA-ManA biosyn.",
  "X1.4.dihydroxy.6.naphthoate.biosynthesis.I " = "1,4 dihydroxy naphthoate biosyn.I",
  "X1.4.dihydroxy.6.naphthoate.biosynthesis.II" = "1,4 dihydroxy naphthoate biosyn.II",
  "allantoin.degradation.to.glyoxylate.III" = "Allantoin → Glyoxylate III",
  "arginine..ornithine.and.proline.interconversion" = "Arg–Orn–Pro interconversion",
  "glycolysis.V..Pyrococcus." = "Glycolysis V Pyro.",
  "heme.biosynthesis.II..anaerobic." = "heme biosyn.II anaerobic",
  "lactose.and.galactose.degradation.I" = "lactose/galactose degr.I",
  "pyrimidine.deoxyribonucleotides.de.novo.biosynthesis.II" = "Pyr dNTP biosyn.II",
  "reductive.acetyl.coenzyme.A.pathway" = "Red. Acetyl-CoA Pathway",
  "superpathway.of.histidine..purine..and.pyrimidine.biosynthesis" = "His. Purine & Pyrimidine Biosyn.",
  "superpathway.of.pyridoxal.5..phosphate.biosynthesis.and.salvage" = "Pyridoxal-5-phosphate Biosyn. & Salvage",
  "purine.nucleotides.degradation.II..aerobic." = "Aerobic Purine Degradation II aerobic.",
  "superpathway.of.L.methionine.biosynthesis..by.sulfhydrylation." = "Sulfhydrylation -> L-methionine Biosyn.",
  "myo.inositol.degradation.I" = "Myo-inositol Degradation I"
  )

feature_rename_all <- c(
  "Dephospho.CoA" = "Dephospho-CoA",
  "GlycA" = "Glycoprotein Acetyls",
  "DHA_pct" = "DHA (% of FAs)",
  "Gly" = "Glycine",
  "Ala" = "Alanine",
  "Glucose.y" = "Glucose",
  "Gln" = "Glutamine-IR",
  "X3.methoxy.acetaminophen" = "3-Methoxy Acetaminophen",
  "DHA_pct" = "DHA (% of FAs)",
  "aldehydo.D.xylose" = "Ald. D-xylose",
  "PUFA_pct" = "PUFA (%)",
  "VLDL_size" = "VLDL-size",
  "L.fucose" = "L-fucose",
  "Thiamin.monophosphate" = "Thiamin monophos.",
  "Insulin_endo" = "Insulin",
  "HOMA_IR" = "Homo-IR",
  "MUFA_pct" = "MUFA (% of FAs)",
  "LA" = "Linoleic acid", 
  "Omega_6" = "Omega6 FA",
  "TCA.cycle.VI..obligate.autotrophs." = "TCA VI (autotrophs)",
  "superpathway.of.sulfur.oxidation..Acidianus.ambivalens." = "Acidianus Ambivalens (Sulfur Oxi.)",
  "NAD.salvage.pathway.II" = "NAD Salvage Pathway II", 
  "g__Acetatifactor" = "G Acetatifactor",
  "indole.3.acetate" = "Indole-3-acetate")

feature_rename_meta_lg <- feature_rename_meta
feature_rename_metabo_lg <- feature_rename_metabo
feature_rename_pathway_lg <- feature_rename_pathway
feature_rename_taxa_lg <- feature_rename_taxa
feature_rename_all_lg <- feature_rename_all
```


```{r}
# Renaming function
rename_features_in_json <- function(json_str, feature_rename_map) {
  # Fix the invalid JSON format by replacing single quotes with double quotes
  json_str <- gsub("'", "\"", json_str)
  
  # Parse the fixed JSON string into a list
  feature_list <- jsonlite::fromJSON(json_str, simplifyDataFrame = FALSE)
  
  # Rename each feature if it's in the mapping
  renamed_list <- lapply(feature_list, function(item) {
    original_name <- item$Feature
    if (original_name %in% names(feature_rename_map)) {
      item$Feature <- feature_rename_map[[original_name]]
    }
    item
  })
  # Convert back to JSON
  toJSON(renamed_list, auto_unbox = TRUE)
}
```


```{r}
# Apply to the column MERF Long
meta <- meta %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_meta)))
#grs <- grs %>%
#  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
#                                              ~rename_features_in_json(.x, feature_rename_grs)))

metabo <- metabo %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_metabo_lg)))
taxa <- taxa %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_taxa_lg)))
pathway <- pathway %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_pathway_lg)))
all <- all %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_all)))
# Apply to the column MERF Delta
meta_md <- meta_md %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_meta)))
#grs_md <- grs_md %>%
# mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
#                                              ~rename_features_in_json(.x, feature_rename_grs)))
metabo_md <- metabo_md %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_metabo)))
taxa_md <- taxa_md %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_taxa)))
pathway_md <- pathway_md %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_pathway)))
all_md <- all_md %>%
  mutate(Top_15_Feature_Importances = map_chr(Top_15_Feature_Importances, 
                                              ~rename_features_in_json(.x, feature_rename_all)))
```

# ANOVA tables for not basic plus 

```{r}
lmer_basic <- lmer(bmi ~ y_new_basic + (1|Cluster), data = gl_lasso_long, REML = FALSE)
lmer_meta_b <- lmer(bmi ~ y_new_basic + y_new_meta + (1|Cluster), data = gl_lasso_long, REML = FALSE)
lmer_grs_b <- lmer(bmi ~ y_new_basic + y_new_grs + (1|Cluster), data = gl_lasso_long, REML = FALSE)

AIC(lmer_basic)
AIC(lmer_grs_b)
```


```{r echo=FALSE, fig.height=5, fig.width=7, out.width="100%", fig.width = 6, fig.asp = 1, warning=FALSE}
### PREDICTED vs ACTUAL BMI 
omic_dfs <- list(
  merf_long = merf_long,
  gl_lasso_long = gl_lasso_long,
  merf_delta = merf_delta, 
  gl_lasso_delta = gl_lasso_delta)

omic_name_labels <- c(
  "merf_long"      = "MERF Longitudinal BMI",
  "gl_lasso_long"  = "GlmmLasso Longitudinal BMI",
  "merf_delta"     = "MERF BMI Changes (Deltas)",
  "gl_lasso_delta" = "GlmmLasso BMI Changes (Deltas)")

for (omic_name in names(omic_dfs)) {
  omic <- omic_dfs[[omic_name]]
  
  # plot linear prediction trend
  cluster_palette <- c("#860018", "#E9A39D", "#C96374", "#D24934", "#582F2B",
    "#A0522D", "#D2691E", "#BD7C5C", "#F08080", "#A12222", "#8B0000", "#FFA07A")
  pred_data <- omic 
  gl_long <- pred_data %>% pivot_longer(cols = starts_with("y_new"),
                                        names_to = "predictor_type", 
                                        values_to = "prediction") %>% 
    mutate(Time = as.factor(Time)) %>% as.data.frame()
  
  long_plot <- ggplot(gl_long, aes(x = bmi, y = prediction, 
                                   color = predictor_type)) +
    geom_point(alpha = 0.6, size = 1) +
    geom_smooth(method = "lm", se = FALSE, size = 1.25) +
    scale_color_manual(values = cluster_palette) +
    labs(title = glue("{omic_name_labels[[omic_name]]} Predicted BMI Values vs. Actual BMI"),
         x = "Actual Test Set BMI",
         y = "Omic Risk Score Predicted BMI",
         color = "Predictor") +
    theme_minimal()
  long_plot
  assign(paste0(omic_name, "_each_omic_plot"), long_plot)
  ggsave(file.path(omic_out_dir, paste0("pred_vs_actual/", omic_name, "_each_omic_plot.png")), plot = long_plot, width = 8, height = 6)
  
  ### ANOVA 
  mod_dat <- omic
  lmer_basic <- lmer(bmi ~ y_new_basic + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_b <- lmer(bmi ~ y_new_basic + y_new_meta + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_grs_b <- lmer(bmi ~ y_new_basic + y_new_grs + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_micom_b <- lmer(bmi ~ y_new_basic + y_new_micom  + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_path_b <- lmer(bmi ~ y_new_basic + y_new_pathway + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_tax_b <- lmer(bmi ~ y_new_basic + y_new_taxa + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_metabo_b <- lmer(bmi ~ y_new_basic + y_new_metabo + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_all_b <- lmer(bmi ~ y_new_basic + y_new_all + (1|Cluster), data = mod_dat, REML = FALSE)
  
  # Put your models into a named list
  models <- list(
    Basic   = lmer_basic,
    `Basic + Clinical`  = lmer_meta_b,
    `Basic + GRS`  = lmer_grs_b,
    `Basic + Micom` = lmer_micom_b,
    `Basic + Pathway` = lmer_path_b,
    `Basic + Taxa`    = lmer_tax_b,
    `Basic + Metabo`  = lmer_metabo_b,
    `Basic + All` = lmer_all_b)
  
  # Extract R2 values for each model
  r2_df <- do.call(rbind, lapply(names(models), function(name) {
    r2_vals <- r.squaredGLMM(models[[name]])
    data.frame(Model = name,
      R2m = r2_vals[1, "R2m"],
      R2c = r2_vals[1, "R2c"])
  }))
  #print(r2_df)
  assign(paste0(omic_name, "_r2_df"), r2_df)
  
  glmmlass_lmer_models <- list(
    c("lmer_basic", "lmer_meta_b"),
    c("lmer_basic", "lmer_grs_b"),
    c("lmer_basic", "lmer_tax_b"),
    c("lmer_basic", "lmer_micom_b"),
    c("lmer_basic", "lmer_path_b"),
    c("lmer_basic", "lmer_metabo_b"),
    c("lmer_basic", "lmer_all_b"))
  
  anova_results <- list()  # empty list to store ANOVA results
  all_anova_tables <- list()
  for (model_pair in glmmlass_lmer_models) {
    model_1 <- get(model_pair[1])
    model_2 <- get(model_pair[2])
    anova_out <- anova(model_1, model_2)  # This works with lmerMod objects
    #tidied_result <- tidy(anova_result)  # Tidy the ANOVA result using broom::tidy()
    anova_out$model_comparison <- paste(model_pair[1], "vs", model_pair[2])
    anova_results[[length(anova_results) + 1]] <- anova_out
  }
  # Combine all results into one dataframe
  anova_table <- do.call(rbind, anova_results)
  anova_table_clean <- anova_table %>%
    dplyr::filter(!is.na(`Chisq`) & !is.na(`Pr(>Chisq)`)) %>%
    mutate(across(where(is.numeric), round, 3)) %>% 
    dplyr::select(-c("npar")) 
  rownames(anova_table_clean) <- NULL

  # Extract model names for reference
  anova_table_clean$model_1 <- gsub(" vs .*", "", anova_table_clean$model_comparison)
  anova_table_clean$model_2 <- gsub(".* vs ", "", anova_table_clean$model_comparison)
  
  # Annotate significance and select relevant columns only
    anova_labels <- anova_table_clean %>%
    dplyr::mutate(
      Compared_Model = dplyr::recode(
        model_comparison,
        "lmer_basic vs lmer_meta_b" = "Basic + Clinical",
        "lmer_basic vs lmer_grs_b" = "Basic + GRS",
        "lmer_basic vs lmer_tax_b" = "Basic + Taxa",
        "lmer_basic vs lmer_micom_b" = "Basic + Micom",
        "lmer_basic vs lmer_path_b" = "Basic + Pathway",
        "lmer_basic vs lmer_metabo_b" = "Basic + Metabo",
        "lmer_basic vs lmer_all_b" = "Basic + All"),
      Significance = case_when(
        `Pr(>Chisq)` < 0.001 ~ "***",
        `Pr(>Chisq)` < 0.01  ~ "**",
        `Pr(>Chisq)` < 0.05  ~ "*",
        TRUE            ~ ""),
      `Pr(>Chisq)` = case_when(
      `Pr(>Chisq)` < 0.001 ~ "<0.001",
      `Pr(>Chisq)` < 0.01  ~ "<0.01",
      TRUE ~ as.character(`Pr(>Chisq)`)
    )) %>%
    dplyr::select(Compared_Model, AIC, `Pr(>Chisq)`, Significance)
  
  r2_annotated <- r2_df %>%
    left_join(anova_labels, by = c("Model" = "Compared_Model"))
  
  basic_aic <- AIC(lmer_basic)
  
  r2_annotated <- r2_annotated %>%
                  dplyr::mutate(AIC = ifelse(Model == "Basic", 
                                             round(basic_aic, 3), AIC))
  
  for_table <- r2_annotated %>% dplyr::select(-c(R2c)) %>% 
               rename("R²*" = R2m, 
                      "P-Value" = `Pr(>Chisq)`)
  
  final_anova_table_initial <- for_table %>% gt() %>%
    tab_header(title = "Model Comparison (ANOVA)") %>%
    fmt_number(columns = where(is.numeric), decimals = 2) %>%
    sub_missing(missing_text = "-") %>%
    cols_width(1 ~ pct(20),
               `R²*` ~ pct(15), 
              Significance ~ pct(15),
              `P-Value` ~ pct(15), 
              AIC ~ pct(11), 
              Significance ~ pct(11)) %>%
    cols_align(align = "center",
      columns = everything()) %>% 
    cols_align("left", columns = Model) %>%
    tab_options(table.width = pct(60),
                table.align = "center") %>%
    opt_table_font(font = list(
        google_font("Arial"),   # fallback to system font if unavailable
        default_fonts())) %>%
    tab_style(style = cell_text(weight = "bold"),
      locations = cells_column_labels())
    
  assign(paste0(omic_name, "_anova_table"), final_anova_table_initial)
  
  model_order <- r2_annotated %>%
    dplyr::filter(Model != "Basic") %>%
    arrange(R2m) %>%
    pull(Model) %>%
    unique() #
  
  # Apply the custom order to your data #START HERE ####
  custom_order <- c("Basic" ,  
                    "Basic + Clinical",
                    "Basic + GRS",
                    "Basic + Pathway", 
                    "Basic + Taxa",
                    "Basic + Micom", 
                    "Basic + Metabo", 
                    "Basic + All")

  r2_annotated %>%
    dplyr::mutate(Model = factor(Model, levels = custom_order)) %>%
    arrange(Model)
  
    # Set factor levels for ordering on x-axis
  r2_annotated$Model <- factor(r2_annotated$Model, levels = c(
    "Basic", 
    "Basic + Clinical", 
    "Basic + GRS",
    "Basic + Taxa", 
    "Basic + Pathway", 
    "Basic + Micom", 
    "Basic + Metabo", 
    "Basic + All"
  ))
  
  basic_aic <- AIC(lmer_basic)
  
  r2_annotated <- r2_annotated %>%
                  dplyr::mutate(AIC = ifelse(Model == "Basic", 
                                             round(basic_aic, 3), AIC))
  
  # Extract R2m value for the "Basic" model
  basic_r2 <- r2_annotated$R2m[r2_annotated$Model == "Basic"]

  # Add horizontal dashed line to the plot
  sig_plot <- ggplot(r2_annotated,
                     aes(x = Model, y = R2m, fill = Model)) +
    geom_col(width = 0.7) +
    geom_text(aes(y = R2m + 0.03, label = Significance), size = 12) +
    #geom_hline(yintercept = basic_r2, linetype = "dashed", color = "black") +  # <<-- New line added
    scale_y_continuous(limits = c(0, 0.58),
                       expand = expansion(mult = c(0, 0.1))) +
    scale_fill_manual(values = c(
      "Basic + All"      = "#b44241",
      "Basic + Metabo"   = "#C76374",
      "Basic + Micom"    = "#996759",
      "Basic + Pathway"  = "#D8A39D",
      "Basic + Taxa"     = "#8B3A3A",
      "Basic + GRS"      = "#E18476",
      "Basic + Clinical" = "#fecdc7",
      "Basic"            = "#A9A9A9")) +
    labs(title = glue("R² {omic_name_labels[[omic_name]]}"),
         #x = "Basic vs. Added Omic Scores",
         x = NULL, 
         y = expression(R^2*" = Fixed Effect Variance")) +
    theme_minimal(base_size = 25) +
    theme(legend.position = "none",
          plot.margin = ggplot2::margin(t = 2, r = 2, b = 2, l = 2, unit = "cm"),
          axis.text.y = element_text(face = "bold", hjust = 1, size = 27),
          axis.text.x = element_text(face = "bold", size = 27, hjust = 1, angle = 45),
          axis.title.x = element_text(margin = ggplot2::margin(0.5,0,0,0, unit = "cm"), size = 30),
          axis.title.y = element_text(margin = ggplot2::margin(0,0.8,0,0, unit = "cm"), size = 30))
  sig_plot
  assign(paste0(omic_name, "_basic_sig_plot"), sig_plot)
  # Save the sig plot
  ggsave(file.path(omic_out_dir, paste0("anova_plots/", omic_name, "_basic_sig_plot.png")), 
         plot = sig_plot,  width = 10, height = 8)
}
```


# Combined ANOVA table initial
```{r echo=FALSE, fig.width = 5, fig.asp = 1, out.width="70%"}
# Assuming you saved the cleaned data frames *before* turning them into gt tables:
all_anova_clean_tables <- list(
  merf_long    = merf_long_anova_table,
  gl_lasso_long = gl_lasso_long_anova_table,
  merf_delta    = merf_delta_anova_table,
  gl_lasso_delta = gl_lasso_delta_anova_table)

raw_tables <- lapply(all_anova_clean_tables, function(gt_obj) gt_obj[["_data"]])

combined_anova_df <- bind_rows(
  lapply(names(raw_tables), function(name) {
    df <- raw_tables[[name]]
    df$Model_Type <- name
    df
    }),
  .id = "Source"
)

# Combined ANOVA table
final_anova_table_initial <- combined_anova_df %>% 
  dplyr::select(-c("Source")) %>% 
  mutate(Model_Type = dplyr::case_when(
    Model_Type == "merf_long" ~ "MERF (Longitudinal BMI prediction)",
    Model_Type == "gl_lasso_long" ~ "GlmmLasso (Longitudinal BMI Prediction)",
    Model_Type == "merf_delta" ~ "MERF (Change in BMI (Delta) Prediction)",
    Model_Type == "gl_lasso_delta" ~ "GlmmLasso (Change in BMI (Delta) Prediction)",
    TRUE ~ Model_Type
  )) %>% 
  gt(groupname_col = "Model_Type") %>%
    tab_header(title = "Additive Model Comparison's (ANOVA)") %>%
    fmt_number(columns = where(is.numeric), decimals = 3) %>%
    #fmt_number(columns = "Df", decimals = 0) %>% 
    sub_missing(missing_text = "-") %>%
    cols_width(1 ~ pct(16),
               `R²*` ~ pct(12), 
               Significance ~ pct(12),
               `P-Value` ~ pct(12), 
               AIC ~ pct(12), 
               Significance ~ pct(12),
               Model_Type ~ pct(12)) %>%
    cols_align(align = "center",
      columns = everything()) %>% 
    cols_align("left", columns = Model) %>%
    tab_options(table.width = pct(90),
                table.align = "center") %>%
    opt_table_font(font = list(
        google_font("Arial"),   # fallback to system font if unavailable
        default_fonts())) %>%
    tab_style(style = cell_text(weight = "bold"),
              locations = cells_column_labels()) %>% 
  tab_style(style = list(
    cell_fill(color = "lightgray"),
    cell_text(weight = "bold",
              size = 12)),
  locations = cells_row_groups())

final_anova_table_initial
gtsave(final_anova_table_initial, 
       filename = paste0(omic_out_dir, "anova_tables/anova_initial_table_with_grs.png"))

```

## Different ANOVA table for basic initial

```{r}
library(dplyr)
library(ggpubr)
library(cowplot)

# Step 1: Prepare and clean data
combined_anova_df <- combined_anova_df %>%
  dplyr::mutate(Model_Type = case_when(
    Model_Type == "merf_long"      ~ "D. MERF (Longitudinal BMI prediction)",
    Model_Type == "gl_lasso_long"  ~ "B. GlmmLasso (Longitudinal BMI Prediction)",
    Model_Type == "merf_delta"     ~ "C. MERF (Change in BMI (Delta) Prediction)",
    Model_Type == "gl_lasso_delta" ~ "A. GlmmLasso (Change in BMI (Delta) Prediction)",
    TRUE ~ Model_Type
  ))

table_data <- combined_anova_df %>%
  dplyr::select(-Source) %>%
  arrange(Model_Type) %>%
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  dplyr::select(-Model_Type)
  
# Step 2: Split by model type
tables <- split(table_data, combined_anova_df$Model_Type)

# Step 3: Create title + table stacked using cowplot
table_grobs <- lapply(names(tables), function(name) {
  
  # Title as a ggdraw object
  title_grob <- cowplot::ggdraw() +
    cowplot::draw_label(name, fontface = "bold", 
                        size = 14, hjust = 0.5,
                        fontfamily = "Arial") +
    theme(plot.margin = ggplot2::margin(0, 0, 0.1, 0))  # space below title
  # Table as a ggdraw object
  table <- ggtexttable(tables[[name]], 
                       theme = ttheme("classic"), rows = NULL)
  table_grob <- cowplot::ggdraw(table)
  # Combine title and table vertically
  cowplot::plot_grid(title_grob, table_grob, 
                     ncol = 1, 
                     rel_heights = c(0.1, 1))
})
# Step 4: Arrange all tables into a grid
final_plot <- cowplot::plot_grid(plotlist = table_grobs, 
                                 ncol = 2, rel_widths = c(1, 1))

# Show plot
print(final_plot)
ggsave(paste0(omic_out_dir, "anova_tables/anova_initial_combined_with_grs.png"), final_plot, 
       width = 30, height = 20, dpi = 300, bg = 'white')
```


## Another ANOVA initial combination 
```{r}
# Create a new Word document
doc <- read_docx()

# Loop over each table
for (name in names(tables)) {
  table_data <- tables[[name]]
  
  # Create a formatted flextable
  ft <- flextable(table_data) %>%
    autofit() %>%
    theme_vanilla() %>%
    set_caption(caption = name) %>%
    fontsize(size = 10, part = "all") %>%
    align(align = "center", part = "all") %>%
    border_remove() %>%
    border_outer(border = fp_border(color = "black", width = 1)) %>%
    border_inner(border = fp_border(color = "gray", width = 0.5))

  # Add a title paragraph
  doc <- doc %>%
    body_add_par(name, style = "heading 2") %>%
    body_add_flextable(ft) %>%
    body_add_par("", style = "Normal")  # Add spacing between tables
}

# Save the Word file
print(doc, target = paste0(omic_out_dir, "anova_tables/anova_initial_combined.docx"))
```


################################################################################

# DO we see and improvement in the omics upon clinical models

```{r}
lmer_meta_b <- lmer(bmi ~ y_new_meta + (1|Cluster), data = gl_lasso_long, REML = FALSE)
lmer_meta_grs <- lmer(bmi ~ y_new_meta + y_new_grs  + (1|Cluster), data = gl_lasso_long, REML = FALSE)

AIC(lmer_meta_b)
AIC(lmer_meta_grs)

r.squaredGLMM(lmer_meta_b)
r.squaredGLMM(lmer_meta_grs)

anova(lmer_meta_b, lmer_meta_grs)
```


```{r}
omic_dfs <- list(
  merf_long = merf_long,
  gl_lasso_long = gl_lasso_long,
  merf_delta = merf_delta, 
  gl_lasso_delta = gl_lasso_delta)

omic_name_labels <- c(
  "merf_long"      = "MERF Longitudinal BMI",
  "gl_lasso_long"  = "GlmmLasso Longitudinal BMI",
  "merf_delta"     = "MERF BMI Changes (Deltas)",
  "gl_lasso_delta" = "GlmmLasso BMI Changes (Deltas)")

for (omic_name in names(omic_dfs)) {
  omic <- omic_dfs[[omic_name]]
  
  ### ANOVA 
  mod_dat <- omic
  lmer_basic_b <- lmer(bmi ~ y_new_basic + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_basic_meta_b <- lmer(bmi ~ y_new_basic + y_new_meta + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_b <- lmer(bmi ~ y_new_meta + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_grs <- lmer(bmi ~ y_new_meta + y_new_grs  + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_micom <- lmer(bmi ~ y_new_meta + y_new_micom  + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_pathway <- lmer(bmi ~ y_new_meta + y_new_pathway + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_taxa <- lmer(bmi ~ y_new_meta + y_new_taxa + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_metabo <- lmer(bmi ~ y_new_meta + y_new_metabo + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_all <- lmer(bmi ~ y_new_meta + y_new_all + (1|Cluster), data = mod_dat, REML = FALSE)
  
  # Put your models into a named list
  models <- list(
    `Clinical`  = lmer_meta_b,
    `Clinical + GRS`  = lmer_meta_grs,
    `Clinical + Micom` = lmer_meta_micom,
    `Clinical + Pathway` = lmer_meta_pathway,
    `Clinical + Taxa`    = lmer_meta_taxa,
    `Clinical + Metabo`  = lmer_meta_metabo,
    `Clinical + All` = lmer_meta_all)
  
  # Extract R2 values for each model
  r2_df_clin_plus <- do.call(rbind, lapply(names(models), function(name) {
    r2_vals_clin_plus <- r.squaredGLMM(models[[name]])
    data.frame(Model = name,
      R2m = r2_vals_clin_plus[1, "R2m"],
      R2c = r2_vals_clin_plus[1, "R2c"])
  }))
  #print(r2_df)
  assign(paste0(omic_name, "_r2_df"), r2_df_clin_plus)
  
  lmer_models <- list(
    c("lmer_meta_b", "lmer_meta_b"),
    c("lmer_meta_b", "lmer_meta_grs"),
    c("lmer_meta_b", "lmer_meta_taxa"),
    c("lmer_meta_b", "lmer_meta_micom"),
    c("lmer_meta_b", "lmer_meta_pathway"),
    c("lmer_meta_b", "lmer_meta_metabo"),
    c("lmer_meta_b", "lmer_meta_all"))
  
  lmer_models_clin_p <- list()  # empty list to store ANOVA results
  all_anova_tables_clin_p <- list()
  for (model_pair in lmer_models) {
    model_1 <- get(model_pair[1])
    model_2 <- get(model_pair[2])
    anova_out_clin_p <- anova(model_1, model_2)  # lmerMod objects
    # tidied_result <- tidy(anova_result)
    anova_out_clin_p$model_comparison <- paste(model_pair[1], "vs", model_pair[2])
    lmer_models_clin_p[[length(lmer_models_clin_p) + 1]] <- anova_out_clin_p
  }
  # Combine all results into one dataframe
  anova_table_clin_p <- do.call(rbind, lmer_models_clin_p)
  anova_table_clean_clin_p <- anova_table_clin_p %>%
    dplyr::filter(!is.na(`Chisq`) & !is.na(`Pr(>Chisq)`)) %>%
    dplyr::mutate(across(where(is.numeric), round, 3)) %>% 
    dplyr::select(-c("npar")) 
  rownames(anova_table_clean_clin_p) <- NULL

  # Extract model names for reference
  anova_table_clean_clin_p$model_1 <- gsub(" vs .*", "", anova_table_clean_clin_p$model_comparison)
  anova_table_clean_clin_p$model_2 <- gsub(".* vs ", "", anova_table_clean_clin_p$model_comparison)
  
  # Annotate significance and select relevant columns only
  anova_labels_clin_p <- anova_table_clean_clin_p %>%
  dplyr::mutate(
    Compared_Model = dplyr::recode(
       model_comparison,
       "lmer_meta_b vs lmer_meta_b" = "Clinical",
       "lmer_meta_b vs lmer_meta_grs" = "Clinical + GRS",
       "lmer_meta_b vs lmer_meta_taxa" = "Clinical + Taxa",
       "lmer_meta_b vs lmer_meta_micom" = "Clinical + Micom",
       "lmer_meta_b vs lmer_meta_pathway" = "Clinical + Pathway",
       "lmer_meta_b vs lmer_meta_metabo" = "Clinical + Metabo",
       "lmer_meta_b vs lmer_meta_all" = "Clinical + All"
    ),
    Significance = case_when(
      `Pr(>Chisq)` < 0.001 ~ "***",
      `Pr(>Chisq)` < 0.01  ~ "**",
      `Pr(>Chisq)` < 0.05  ~ "*",
      TRUE            ~ ""
    ),
    `Pr(>Chisq)` = case_when(
      `Pr(>Chisq)` < 0.001 ~ "<0.001",
      `Pr(>Chisq)` < 0.01  ~ "<0.01",
      TRUE ~ as.character(`Pr(>Chisq)`)
    )
  ) %>%
  dplyr::select(Compared_Model, AIC, `Pr(>Chisq)`, Significance)
  
  # Apply the custom order to your data #START HERE ####
  custom_order_clin_plus <- c("Clinical", 
                              "Clinical + GRS",
                              "Clinical + Pathway", 
                              "Clinical + Taxa",
                              "Clinical + Micom", 
                              "Clinical + Metabo", 
                              "Clinical + All")
  
  r2_annotated_clin_plus <- r2_df_clin_plus %>%
                            left_join(anova_labels_clin_p, 
                                      by = c("Model" = "Compared_Model")) %>%
                            dplyr::mutate(Model = factor(Model, 
                                 levels = custom_order_clin_plus)) %>%
                                 arrange(Model)
  clinical_aic <- AIC(lmer_meta_b)
  
  r2_annotated_clin_plus <- r2_annotated_clin_plus %>%
  dplyr::mutate(AIC = ifelse(Model == "Clinical", round(clinical_aic, 3), AIC))
  
  for_table_cp <- r2_annotated_clin_plus %>% 
               dplyr::select(-c(R2c)) %>% 
               rename("R²" = R2m, 
                      "P-Value" = `Pr(>Chisq)`)  %>%
  mutate(across(c(`P-Value`, Significance), ~replace_na(., "-")))
  
  final_anova_table_clin_p <- for_table_cp %>% gt() %>%
    tab_header(title = "Model Comparison (ANOVA)") %>%
    fmt_number(columns = where(is.numeric), decimals = 2) %>%
    sub_missing(missing_text = "-") %>%
    cols_width(1 ~ pct(20),
               `R²` ~ pct(15), 
              Significance ~ pct(15),
              `P-Value` ~ pct(15), 
              AIC ~ pct(11), 
              Significance ~ pct(11)) %>%
    cols_align(align = "center",
      columns = everything()) %>% 
    cols_align("left", columns = Model) %>%
    tab_options(table.width = pct(60),
                table.align = "center") %>%
    opt_table_font(font = list(
        google_font("Arial"),   # fallback to system font if unavailable
        default_fonts())) %>%
  # Style body text
  tab_style(style = cell_text(size = 14),
    locations = cells_body()) %>%
  # Style column labels
  tab_style(style = cell_text(size = 16, weight = "bold"),
    locations = cells_column_labels()) %>%
  # Style title
  tab_style(style = cell_text(size = 18, weight = "bold"),
    locations = cells_title())
  assign(paste0(omic_name, "_anova_table_clin_p"), final_anova_table_clin_p)
  
  ## And plot the anova 
  basic_r2 <- r2_annotated_clin_plus$R2m[r2_annotated_clin_plus$Model == "Clinical"]
  sig_plot_clin_plus <- ggplot(r2_annotated_clin_plus, 
                     aes(x = Model, y = R2m, fill = Model)) +
    geom_col(width = 0.7) +
    geom_text(aes(y = R2m + 0.036, label = Significance), size = 12) +
    #geom_hline(yintercept = basic_r2, linetype = "dashed", color = "black") +
    scale_y_continuous(limits = c(0, 0.72),
                       expand = expansion(mult = c(0, 0.1))) +
    scale_fill_manual(values = c(
      "Clinical + All"      = "#b44241",
      "Clinical + Metabo"   = "#C76374",
      "Clinical + Micom"    = "#996759",
      "Clinical + Pathway"  = "#D8A39D",
      "Clinical + Taxa"     = "#8B3A3A",
      "Clinical + GRS"      = "#E18476",
      "Clinical"            = "#A9A9A9")) +
    labs(title = glue("R² {omic_name_labels[[omic_name]]}"),
      #x = "Clinical vs. Added Omic Scores",
      x = NULL, 
      y = expression(R^2*" = Fixed Effect Variance")) +
    theme_minimal(base_size = 28) +
    theme(legend.position = "none",
          plot.margin = ggplot2::margin(t = 2, r = 2, b = 2, l = 2, unit = "cm"),
      axis.text.y = element_text(face = "bold", hjust = 1, size = 27),
      axis.text.x = element_text(face = "bold", size = 27, hjust = 1, angle = 45),
      axis.title.x = element_text(margin = ggplot2::margin(0.5,0,0,0, unit = "cm"), size = 30),
      axis.title.y = element_text(margin = ggplot2::margin(0,0.8,0,0, unit = "cm"), size = 30))
  assign(paste0(omic_name, "_sig_plot_clin_plus"), sig_plot_clin_plus)
}
```


```{r}
# Assuming you saved the cleaned data frames *before* turning them into gt tables:
all_anova_clean_tables_clin_p <- list(
  merf_long    = merf_long_anova_table_clin_p,
  gl_lasso_long = gl_lasso_long_anova_table_clin_p,
  merf_delta    = merf_delta_anova_table_clin_p,
  gl_lasso_delta = gl_lasso_delta_anova_table_clin_p)

raw_tables_clin_p <- lapply(all_anova_clean_tables_clin_p, 
                            function(gt_obj) gt_obj[["_data"]])

combined_anova_df_clin_p <- bind_rows(
  lapply(names(raw_tables_clin_p), function(name) {
    df <- raw_tables_clin_p[[name]]
    df$Model_Type <- name
    df
    }),
  .id = "Source"
)

# Step 1: Prepare and clean data
combined_anova_df_clin_p <- combined_anova_df_clin_p %>%
  dplyr::mutate(Model_Type = case_when(
    Model_Type == "merf_long"      ~ "D. MERF (Longitudinal BMI prediction)",
    Model_Type == "gl_lasso_long"  ~ "B. GlmmLasso (Longitudinal BMI Prediction)",
    Model_Type == "merf_delta"     ~ "C. MERF (Change in BMI (Delta) Prediction)",
    Model_Type == "gl_lasso_delta" ~ "A. GlmmLasso (Change in BMI (Delta) Prediction)",
    TRUE ~ Model_Type
  ))

table_data_clin_p <- combined_anova_df_clin_p %>%
  dplyr::select(-Source) %>%
  arrange(Model_Type) %>%
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  dplyr::select(-Model_Type)

# Step 2: Split by model type
tables_clin_p <- split(table_data_clin_p, combined_anova_df_clin_p$Model_Type)

# Step 3: Create title + table stacked using cowplot
table_grobs_clin_p <- lapply(names(tables_clin_p), function(name) {
  
  # Title as a ggdraw object
  title_grob_clin_p <- cowplot::ggdraw() +
    cowplot::draw_label(name, fontface = "bold", size = 12,
                        hjust = 0.5, vjust = 12,
                        fontfamily = "Arial") +
    theme(plot.margin = ggplot2::margin(0, 0, 0, 0))  # space below title
  # Table as a ggdraw object
  table_clin_p <- ggtexttable(tables_clin_p[[name]], 
                       theme = ttheme("classic"), rows = NULL)
  table_grob_clin_p <- cowplot::ggdraw(table_clin_p)
  # Combine title and table vertically
  cowplot::plot_grid(title_grob_clin_p, table_grob_clin_p, 
                     ncol = 1, 
                     rel_heights = c(0.08, 1),
                     align = 'v')
})
# Step 4: Arrange all tables into a grid
final_plot_clin_p <- cowplot::plot_grid(plotlist = table_grobs_clin_p, 
                                        ncol = 2, rel_widths = c(1, 1))

# Show plot
print(final_plot_clin_p)
ggsave(paste0(omic_out_dir, "anova_plots/anova_clinical_combined.png"), final_plot_clin_p, 
       width = 30, height = 20, dpi = 600, bg = 'white')

# Combined ANOVA table
final_anova_table_clin_p2 <- combined_anova_df_clin_p %>% 
  dplyr::select(-c("Source")) %>% 
  mutate(Model_Type = dplyr::case_when(
    Model_Type == "merf_long" ~ "MERF (Longitudinal BMI prediction)",
    Model_Type == "gl_lasso_long" ~ "GlmmLasso (Longitudinal BMI Prediction)",
    Model_Type == "merf_delta" ~ "MERF (Change in BMI (Delta) Prediction)",
    Model_Type == "gl_lasso_delta" ~ "GlmmLasso (Change in BMI (Delta) Prediction)",
    TRUE ~ Model_Type
  )) %>% 
  gt(groupname_col = "Model_Type") %>%
    tab_header(title = "Additive Model Comparison's (ANOVA)") %>%
    fmt_number(columns = where(is.numeric), decimals = 3) %>%
    #fmt_number(columns = "Df", decimals = 0) %>% 
    sub_missing(missing_text = "-") %>%
    cols_width(1 ~ pct(16),
               `R²` ~ pct(10), 
               Significance ~ pct(10),
               `P-Value` ~ pct(10), 
               AIC ~ pct(10), 
               Model_Type ~ pct(12)) %>%
    cols_align(align = "center",
      columns = everything()) %>% 
    cols_align("left", columns = Model) %>%
    tab_options(table.width = pct(90),
                table.align = "center") %>%
    opt_table_font(font = list(
        google_font("Arial"),   # fallback to system font if unavailable
        default_fonts())) %>%
    tab_style(style = cell_text(weight = "bold"),
              locations = cells_column_labels()) %>% 
  tab_style(style = list(
    cell_fill(color = "lightgray"),
    cell_text(weight = "bold",
              size = 12)),
  locations = cells_row_groups())

final_anova_table_clin_p2
gtsave(final_anova_table_clin_p, filename = paste0(omic_out_dir, "anova_tables/anova_table_clin_p.png"))
```

# ANOVA TABLE FOR CLINICAL ANOVA COMBINED 
```{r}
library(officer)
library(flextable)
library(magrittr)

# Create a new Word document
doc <- read_docx()

# Loop over each table
for (name in names(tables_clin_p)) {
  table_data <- tables_clin_p[[name]]
  
  # Create a formatted flextable
  ft <- flextable(table_data) %>%
    autofit() %>%
    theme_vanilla() %>%
    set_caption(caption = name) %>%
    fontsize(size = 10, part = "all") %>%
    align(align = "center", part = "all") %>%
    border_remove() %>%
    border_outer(border = fp_border(color = "black", width = 1)) %>%
    border_inner(border = fp_border(color = "gray", width = 0.5))

  # Add a title paragraph
  doc <- doc %>%
    body_add_par(name, style = "heading 2") %>%
    body_add_flextable(ft) %>%
    body_add_par("", style = "Normal")  # Add spacing between tables
}

# Save the Word file
print(doc, target = paste0(omic_out_dir, "anova_tables/anova_clinical_combined.docx"))
```

```{r}
plot_names <- glue("{names(omic_dfs)}_basic_sig_plot")
plot_names_clin_plus <- glue("{names(omic_dfs)}_sig_plot_clin_plus")
```


################## FEATURE IMPORTANCES MERF #########################################
# Figure xxx : MERF feature importances

```{r echo=FALSE, fig.width = 6.5, fig.asp = 1.6, out.width="90%"}
merf_dfs_long <- list(Basic = basic, Labs = meta, 
                      GRS = grs,
               Taxa = taxa, Micom = micom, 
               Pathway = pathway, Metabolomics = metabo, 
               All = all)

merf_dfs_delta <- list(Basic = basic_md, Labs = meta_md, 
                       GRS = grs_md, 
                     Taxa = taxa_md, Micom = micom_md, 
                     Pathway = pathway_md, Metabolomics = metabo_md, 
                     All = all_md)

ft_colors <- c(Labs = "#fecdc7", Taxa = "#8B3A3A", 
               Micom = "#996759", Pathway = "#D8A39D", 
               Metabolomics  = "#C76374", 
               All = "#b44241", GRS = "#E18476",
               Basic = "#582F2B")

ft_colors_delta <- c(Labs = "#fecdc7", Taxa = "#8B3A3A", 
                     Micom = "#996759", Pathway = "#D8A39D", 
                     Metabolomics  = "#C76374", 
                     All = "#b44241", GRS = "#E18476",
                     Basic = "#582F2B")

# Combined feature sets
all_ft_dfs <- list(merf_lg = list(data = merf_dfs_long, 
                                  colors = ft_colors, 
                             label = "MERF (Longitudinal BMI Prediction)", 
                             model_label = "MERF (Longitudinal BMI Prediction)",
                             x_ax_label = "Feature Importance"),
                   merf_delta = list(data = merf_dfs_delta, 
                                     colors = ft_colors_delta, 
                                label = "MERF (Change in BMI (Delta) Prediction)", 
                                model_label = "MERF (Change in BMI (Delta) Prediction)",
                                x_ax_label = "Feature Importance"))

merf_plots <- list()
for (type in names(all_ft_dfs)) {
  ft_set <- all_ft_dfs[[type]]$data
  color_map <- all_ft_dfs[[type]]$colors
  label <- all_ft_dfs[[type]]$label
  model_label <- all_ft_dfs[[type]]$model_label  # "MERF" or "GlmmLasso"
  x_ax_label <- all_ft_dfs[[type]]$x_ax_label
  
  output_dir <- file.path("omic_out_dir", paste0("ft_imp_", model_label, "_", label))
  dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
  
  for (ft_name in names(ft_set)) {
    omic <- ft_set[[ft_name]]
    
    omic_parsed <- omic %>%
      mutate(Top_15_Feature_Importances = gsub("'", '"', Top_15_Feature_Importances)) %>%
      mutate(parsed = map(Top_15_Feature_Importances, fromJSON))
    
    omic_long <- omic_parsed %>%
      unnest(parsed) %>%
      dplyr::select(-Top_15_Feature_Importances) %>%
      dplyr::filter(Feature != "time") %>% 
      dplyr::filter(Model == "MSE Model")
    
    avg_importance <- omic_long %>%
      group_by(Feature) %>%
      summarise(avg_importance = mean(Importance, na.rm = TRUE), .groups = "drop") %>%
      slice_max(order_by = avg_importance, n = 10, with_ties = FALSE) %>%
      dplyr::filter(avg_importance != 0)
    
    avg_imp_name <- paste0("av_imp_", type, "_", ft_name, "_", label)
    assign(avg_imp_name, avg_importance, envir = .GlobalEnv)
    
    max_val <- max(avg_importance$avg_importance, na.rm = TRUE)
    x_limit <- ceiling(max_val / 0.05) * 0.05
 
    #plot <- ggplot(avg_importance, 
    #   aes(x = avg_importance, 
    #       y = reorder(Feature, avg_importance))) +
    #geom_point(size = 6, color = color_map[[ft_name]]) +
    plot <- ggplot(avg_importance, 
       aes(x = 0, 
           y = reorder(Feature, avg_importance))) +
    geom_segment(aes(xend = avg_importance, 
                     yend = reorder(Feature, avg_importance)),
                 lineend = "round", linewidth = 15, 
                 color = color_map[[ft_name]]) +
    labs(title = paste(label, " ~ ",toupper(ft_name)),
       x = paste(" ", x_ax_label),
       y = NULL) +
    theme_minimal() +
    scale_x_continuous(limits = c(0, x_limit), 
                       expand = expansion(mult = c(0, 0.02))) +
    theme(
      plot.background = element_blank(),
      #plot.background = element_rect(fill = "white"),
      plot.title = element_text(hjust = 0, face = "bold", size = 28),
      plot.margin = ggplot2::margin(r = 10, l = 2, t = 3, b = 3),
      axis.text.y = element_text(face = "bold", size = 32),
      axis.text.x = element_text(face = "bold", size = 32),
      axis.title.x = element_text(size = 28, margin = ggplot2::margin(t = 12)),
      panel.grid.major.y = element_blank(), 
      panel.border     = element_blank(),  
      panel.background = element_blank(),
      panel.grid.minor = element_blank())

    # Save to named R object
    object_name <- paste0("plot_", type, "_", ft_name, "_", label)
    assign(object_name, plot, envir = .GlobalEnv)
    merf_plots[[object_name]] <- plot
    png_name <- file.path(output_dir, paste0("feature_importance_", ft_name, "_", label, ".png"))
    ggsave(filename = png_name, plot = plot, width = 12, height = 5, dpi = 300)
  }
}
```


################## FEATURE IMPORTANCES GLMMLASSO #########################################

```{r echo=FALSE, fig.height=5, fig.width=7, out.width="100%"}

lass_dfs_long <- list(Basic = gl_ftimp_long_basic, 
                      Labs = gl_ftimp_long_meta, 
                      GRS = gl_ftimp_long_grs,
                      Taxa = gl_ftimp_long_taxa, 
                      Micom = gl_ftimp_long_micom, 
                      Pathway = gl_ftimp_long_pathway, 
                      Metabolomics = gl_ftimp_long_metabo, 
                      All = gl_ftimp_long_all)

lass_dfs_delta <- list(Basic = gl_ftimp_delta_basic, 
                       Labs = gl_ftimp_delta_meta, 
                       GRS = gl_ftimp_delta_grs,
                       Taxa = gl_ftimp_delta_taxa, 
                       Micom = gl_ftimp_delta_micom, 
                       Pathway = gl_ftimp_delta_pathway, 
                       Metabolomics = gl_ftimp_delta_metabo, 
                       All = gl_ftimp_delta_all)

# Combined feature sets
all_lass_ft_dfs <- list(lass_lg = list(data = lass_dfs_long, colors = ft_colors, 
                                  label = "long", 
                                  model_label = "GlmmLasso (Longitudinal BMI Prediction)",
                                  x_ax_label = "Feature Co-efficient"),
                   lass_delta = list(data = lass_dfs_delta, colors = ft_colors_delta, 
                                     label = "delta", 
                                     model_label = "GlmmLasso (Change in BMI (Delta) Prediction)",
                                     x_ax_label = "Feature Co-efficient"))
imap_dfr(lass_dfs_long, ~ 
           summarise(.x, min = min(Estimate, na.rm = TRUE), max = max(Estimate, na.rm = TRUE)) %>%
           mutate(name = .y)) %>% bind_rows() %>% dplyr::select(name, min, max)

imap_dfr(lass_dfs_delta, ~ 
           summarise(.x, min = min(Estimate, na.rm = TRUE), max = max(Estimate, na.rm = TRUE)) %>%
           mutate(name = .y)) %>% bind_rows() %>% dplyr::select(name, min, max)

lass_plots_lg <- list()
lass_plots_delta <- list()

for (type in names(all_lass_ft_dfs)) {
  ft_set <- all_lass_ft_dfs[[type]]$data
  color_map <- all_lass_ft_dfs[[type]]$colors
  label <- all_lass_ft_dfs[[type]]$label
  model_label <- all_lass_ft_dfs[[type]]$model_label
  x_ax_label <- all_lass_ft_dfs[[type]]$x_ax_label

  for (ft_name in names(ft_set)) {
    top_features <- ft_set[[ft_name]]
    ymin <- -1.0
    ymax <- 1.1
    plot_feat <- top_features %>%
      dplyr::filter(!str_detect(tolower(Feature), "time")) %>%
      slice_head(n = 10) %>%
      mutate(Estimate_capped = pmin(pmax(Estimate, ymin), ymax))

    features <- ggplot(plot_feat,
       aes(x = 0,
           y = reorder(Feature, Estimate_capped))) +
      geom_segment(aes(xend = Estimate_capped,
                     yend = reorder(Feature, Estimate_capped)),
                 lineend = "round", linewidth = 15,
                 color = color_map[[ft_name]]) +
      ggtitle(paste("Top Features & Coefficients from glmmLasso Models", ft_name)) +
      labs(title = paste(model_label, toupper(ft_name)),
           y = NULL,
           x = paste("", x_ax_label)) +
      theme_minimal(base_size = 14) +
      theme(
        #plot.background = element_rect(fill = "white"),
        plot.title = element_text(hjust = 0, face = "bold", size = 28),
        plot.margin = ggplot2::margin(r = 10, l = 2, t = 3, b = 3),
        axis.text.y = element_text(face = "bold", size = 32),
        axis.text.x = element_text(face = "bold", size = 32),
        axis.title.x = element_text(size = 28, margin = ggplot2::margin(t = 12)),
        panel.grid.major.y = element_blank(),
        plot.background  = element_blank(), 
        panel.border     = element_blank(),  
        panel.background = element_blank(),
        panel.grid.minor = element_blank()) +
      scale_y_discrete(expand = expansion(mult = c(0.05, 0.05)))

    object_name <- paste0("plot_", type, "_", ft_name, "_", label)
    assign(object_name, features, envir = .GlobalEnv)

    # Save to appropriate list
    if (type == "lass_lg") {
      lass_plots_lg[[ft_name]] <- features
    } else if (type == "lass_delta") {
      lass_plots_delta[[ft_name]] <- features
    }

    # Optional PNG saving
    png_name <- file.path(omic_out_dir, paste0("lass_ft_imp/feature_importance_",
                                             ft_name, "_", label, ".png"))
    ggsave(filename = png_name, plot = features, width = 9, height = 5, dpi = 300)
  }
}

```



### COMBINE ANOVA R2, MERF and GLMMLASSO plots ###
# For 4 figures set up ANOVA
```{r}
## Testing all at once 
bl <- c(mget(plot_names[c(1,2)]), merf_plots[c(2, 3, 6, 7, 8)],  lass_plots_lg[c(2, 7)])
p <- ggdraw()
p <- p +
  draw_plot(bl[[1]], x = 0, y = 0.6+ 0.15, width = 0.48, height = 0.22) + #A
  draw_plot(bl[[2]], x = 0, y = 0.4+ 0.15, width = 0.48, height = 0.22) + #B
  
  draw_plot(bl[[3]], x = 0.53, y = 0.8 + 0.04, width = 0.46, height = 0.13) + #E
  draw_plot(bl[[4]], x = 0.55, y = 0.66 + 0.04, width = 0.44, height = 0.11) + #F
  draw_plot(bl[[5]], x = 0.51, y = 0.44 + 0.04, width = 0.48, height = 0.19) + #G
  draw_plot(bl[[6]], x = 0.51, y = 0.22 + 0.04, width = 0.48, height = 0.19) + #H
  draw_plot(bl[[7]], x = 0.51, y = 0 + 0.04, width = 0.48, height = 0.19) + #I
  
  draw_plot(bl[[8]], x = 0.01, y = 0.2+ 0.1, width = 0.47, height = 0.22) +   #C
  draw_plot(bl[[9]], x = 0.01, y = 0 + 0.04,   width = 0.47, height = 0.22) #D
  
labels <- c("A.", "B.", "C.", "D.", "E.", "F.", "G.", "H.", "I.")
label_x <- c(0.01, 0.01, 0.01, 0.01, rep(0.51, 5))
label_y <- c(0.6+0.15+0.22, 0.4+0.15+0.22, 
             0.2+0.1+0.22, 0+0.05+0.22, 
             0.6+0.15+0.23, 0.62+0.2,
             0.67, 0.47, 
             0+0.05+0.22)
p <- p + draw_plot_label(label = labels, x = label_x, y = label_y,
                         fontface = "bold", size = 25)

ggsave(paste0(omic_out_dir, "aov_feats_combined/basic_long_test.png"), p, 
       width = 40, height = 40, dpi = 600, bg = 'white')

# new way basic delta
bd <- c(mget(plot_names[c(3,4)]), merf_plots[c(10, 12, 15, 16)],  lass_plots_delta[c(2, 7)])
pd <- ggdraw()
pd <- pd +
  draw_plot(bd[[1]], x = 0, y = 0.6+ 0.15, width = 0.5, height = 0.22) +
  draw_plot(bd[[2]], x = 0, y = 0.4+ 0.15, width = 0.5, height = 0.22) +
  draw_plot(bd[[7]], x = 0.01, y = 0.2+ 0.1, width = 0.5, height = 0.22) +   
  draw_plot(bd[[8]], x = 0.01, y = 0 + 0.05,   width = 0.5, height = 0.22)   
# Right side 
right_ysd <- seq(0.7, 0, length.out = 4)  # y positions for 4 plots
for (i in 1:4) {
  pd <- pd + draw_plot(bd[[i+2]], x = 0.52, y = 0.05 + right_ysd[i], width = 0.4, height = 0.215)
}
labelsd <- c("A.", "B.", "C.", "D.", "E.", "F.", "G.", "H.")
label_xd <- c(0.01, 0.01, 0.01, 0.01, rep(0.516, 4))
label_yd <- c(0.6+0.15+0.22, 
             0.4+0.15+0.22, 
             0.2+0.1+0.22, 
             0+0.05+0.22, 
             right_ysd + 0.05 + 0.215)
pd <- pd + draw_plot_label(label = labelsd, x = label_xd, y = label_yd,
                           fontface = "bold", size = 25)

ggsave(paste0(omic_out_dir, "aov_feats_combined/basic_delta_test.png"), pd, 
       width = 40, height = 40, dpi = 400, bg = 'white')

# New way clinical long 
cl <- c(mget(plot_names_clin_plus[c(1,2)]), merf_plots[c(7, 8)],  lass_plots_lg[c(3,7)])
p_cl <- ggdraw()
p_cl <- p_cl +
  draw_plot(cl[[1]], x = 0.01, y = 0.59, width = 0.47, height = 0.22) +
  draw_plot(cl[[2]], x = 0.01, 0.22 + 0.1, width = 0.47, height = 0.22) +
  draw_plot(cl[[3]], x = 0.51, y = 0.59, width = 0.48, height = 0.22) +
  draw_plot(cl[[4]], x = 0.51, y = 0.22 + 0.1, width = 0.48, height = 0.22) +
  draw_plot(cl[[5]], x = 0.01, y = 0.05, width = 0.47, height = 0.22) +
  draw_plot(cl[[6]], x = 0.51, y = 0.05, width = 0.48, height = 0.22) 

labelcl <- c("A.", "B.", "C.", "D.", "E.", "F.")
label_xcl <- c(0.01, 0.01, 0.50, 0.50, 0.01, 0.50)
label_ycl <- c(0.59 + 0.21, 0.32 + 0.22, 0.59 + 0.21, 0.32 + 0.22, 0.05 + 0.22, 0.05 + 0.22)
p_cl <- p_cl + draw_plot_label(label = labelcl, x = label_xcl, y = label_ycl,
                               fontface = "bold", size = 25)

ggsave(paste0(omic_out_dir, "aov_feats_combined/clin_long_test.png"), p_cl, 
       width = 40, height = 40, dpi = 400, bg = 'white')

# New way clinical delta 
cd <- c(mget(plot_names_clin_plus[c(3,4)]), merf_plots[c(12, 15, 16)],  lass_plots_delta[c(2)])
p_cd <- ggdraw()
p_cd <- p_cd +
  draw_plot(cd[[1]], x = 0.01, y = 0.59, width = 0.47, height = 0.22) +
  draw_plot(cd[[2]], x = 0.01, 0.22 + 0.1, width = 0.47, height = 0.22) +
  draw_plot(cd[[3]], x = 0.51, y = 0.59, width = 0.48, height = 0.22) +
  draw_plot(cd[[4]], x = 0.51, y = 0.22 + 0.1, width = 0.48, height = 0.22) +
  draw_plot(cd[[5]], x = 0.51, y = 0.05, width = 0.48, height = 0.22) +
  draw_plot(cd[[6]], x = 0.01, y = 0.05, width = 0.47, height = 0.22)

labelcd <- c("A.", "B.", "D.", "E.", "F.", "C.")
label_xcd <- c(0.01, 0.01, 0.50, 0.50, 0.50, 0.01)
label_ycd <- c(0.59 + 0.21, 0.32 + 0.22, 0.59 + 0.21, 0.32 + 0.22, 0.05 + 0.22, 0.05 + 0.22)
p_cd <- p_cd + draw_plot_label(label = labelcd, x = label_xcd, y = label_ycd,
                               fontface = "bold", size = 25)

ggsave(paste0(omic_out_dir, "aov_feats_combined/clin_delta_test.png"), p_cd, 
       width = 40, height = 40, dpi = 400, bg = 'white')
```

## Heatmap

```{r echo=FALSE, fig.asp = 1.6, fig.width=7, out.width="100%"}
common_cols <- c("bmi", "y_new_basic", "y_new_grs",
                 "y_new_meta", "y_new_taxa", 
                 "y_new_micom", "y_new_pathway", 
                 "y_new_metabo", "y_new_all")

df_list_long <- list(merf_long = merf_long[common_cols],
                 gl_lasso_long = gl_lasso_long[common_cols])
df_list_delta <- list(merf_delta = merf_delta[common_cols],
                  gl_lasso_delta = gl_lasso_delta[common_cols])
# Step 1: Compute correlations for each dataframe
cor_matrices_long <- map(df_list_long, ~ cor(.x, use = "complete.obs"))
cor_matrices_delta <- map(df_list_delta, ~ cor(.x, use = "complete.obs"))

# Fix: Proper binding of melted correlation matrices
cor_long_df <- list(
  merf_long = reshape2::melt(cor_matrices_long$merf_long) %>% 
              mutate(method = "Merf", type = "Longitudinal BMI Scores"),
  gl_lasso_long = reshape2::melt(cor_matrices_long$gl_lasso_long) %>% 
                  mutate(method = "glmmLasso", type = "Longitudinal BMI Scores"),
  merf_delta = reshape2::melt(cor_matrices_delta$merf_delta) %>% 
               mutate(method = "Merf", type = "BMI Change Scores"),
  gl_lasso_delta = reshape2::melt(cor_matrices_delta$gl_lasso_delta) %>% 
                   mutate(method = "glmmLasso", type = "BMI Change Scores")) %>% 
  bind_rows() %>%
    mutate(Var1 = fct_recode(Var1,
                        "Actual BMI" = "bmi",
                        "Basic Score" = "y_new_basic",
                        "Meta Score" = "y_new_meta",
                        "GRS Score" = "y_new_grs",
                        "Taxa Score" = "y_new_taxa",
                        "Micom Score" = "y_new_micom",
                        "Pathway Score" = "y_new_pathway",
                        "Metabolomics Score" = "y_new_metabo",
                        "All Omic Score" = "y_new_all"),
      Var2 = fct_recode(Var2,
                        "Actual BMI" = "bmi",
                        "Basic Score" = "y_new_basic",
                        "Meta Score" = "y_new_meta",
                        "GRS Score" = "y_new_grs",
                        "Taxa Score" = "y_new_taxa",
                        "Micom Score" = "y_new_micom",
                        "Pathway Score" = "y_new_pathway",
                        "Metabolomics Score" = "y_new_metabo",
                        "All Omic Score" = "y_new_all"))

final_heat <- ggplot(cor_long_df, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  facet_grid(method ~ type) +
  scale_fill_gradient2(low = "#09236c", high = "#781720",
                       mid = "white", midpoint = 0.0,
                       limit = c(-0.3, 1), name = "Correlation") +
  theme_minimal(base_size = 16) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15),
        axis.text.y = element_text(size = 15), 
        strip.text = element_text(face = "bold", size = 16)) +
  labs(title = "Correlation Heatmaps: Long vs Delta", x = "", y = "")
```

```{r}
png_name <- file.path(omic_out_dir, paste0("final_heat_map_scores", ".png"))
ggsave(filename = png_name, plot = final_heat, width = 14, height = 10, dpi = 300)
```

```{r echo=FALSE, fig.asp = 0.75, fig.width=10, out.width="95%"}
final_heat
```

#### Ven Diagram 

```{r echo=FALSE, fig.asp = 1.8, fig.width=10, out.width="80%"}
# Function to extract top 20 features from MERF-style data
get_top_features <- function(df) {
  df %>%
    mutate(Top_15_Feature_Importances = gsub("'", '"', Top_15_Feature_Importances)) %>%
    mutate(parsed = map(Top_15_Feature_Importances, fromJSON)) %>%
    unnest(parsed) %>%
    filter(Feature != "time") %>%
    group_by(Feature) %>%
    summarise(avg_importance = mean(Importance, na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(avg_importance)) %>%
    slice_head(n = 20) %>%
    pull(Feature)
}

# Define omics and assign colors
omic_types <- c("basic", "meta", "taxa", "micom", "pathway", "metabo", "all")
venn_colors <- c("#d2495e", "#e9919c", "#5d2a3b", "#f1c28d", "#c0522d", "#f1cabb", "#872657")

# Output directory
venn_out_dir <- "venn_outputs"  # Change this if needed
dir.create(venn_out_dir, showWarnings = FALSE)

# Loop through each omic type
venn_plots_4_ <- list() 
for (i in seq_along(omic_types)) {
  omic <- omic_types[i]
  color <- venn_colors[i %% length(venn_colors) + 1]  # rotate if more omics than colors
  
  # Extract top 20 from GLMM
  top_glmm_lg <- get(paste0("gl_ftimp_long_", omic)) %>%
    arrange(desc(abs_estimate)) %>%
    slice_head(n = 20) %>%
    pull(Feature)
  
  top_glmm_delta <- get(paste0("gl_ftimp_delta_", omic)) %>%
    arrange(desc(abs_estimate)) %>%
    slice_head(n = 20) %>%
    pull(Feature)
  
  # Extract top 20 from MERF
  top_merf_lg <- get_top_features(get(omic))
  top_merf_delta <- get_top_features(get(paste0(omic, "_md")))
  
  # Prepare input
  venn_input <- list(
    `GLMM LG` = unique(top_glmm_lg),
    `GLMM DELTA` = unique(top_glmm_delta),
    `MERF LG` = unique(top_merf_lg),
    `MERF DELTA` = unique(top_merf_delta))
  
  # Generate Venn diagram
  venn_plot <- venn.diagram(
    x = venn_input,
    filename = NULL,
    fill = rep(color, 4),
    alpha = 0.5,
    cex = 0.9,
    cat.cex = 0.9,
    #cat.fontface = "bold",
    cat.fontfamily = "Arial",
    fontfamily = "Arial",
    #main = paste("Top Feature Overlaps -", toupper(omic)),
    #main.cex = 1.2,
    #main.pos = c(0.5, 0.30),
    cat.dist = c(0.3, 0.3, 0.20, 0.20),
    cat.pos = c(-26, 26, -20, 20),
    margin = 0.3)
  
  venn_plots_4_[[omic]] <- venn_plot
  
  # Save to file
  file_path <- file.path(omic_out_dir, paste0("venn_4set_", omic, ".png"))
  png(file_path, width = 1200, height = 1000, res = 300)
  
  grid.newpage()
  
  # Add title BEFORE drawing the Venn plot
  grid.text(
    #paste("Top Feature Overlap -", toupper(omic), " Models"),
    paste("Overlap of ", toupper(omic), " Models Top Features"),
    x = 0.5, y = 0.90,                    # Centered and near the top
    gp = gpar(fontsize = 12, fontface = "bold", fontfamily = "Arial"),
    just = "center")
  
  # Draw Venn diagram
  grid.draw(venn_plot)
  
  dev.off()
}
```


```{r}
library(grid)
library(gridExtra)

# Select omics to display
selected_omics <- c("meta", "taxa", "micom", "pathway", "metabo", "all")

display_names <- c(
  meta = "Clinical",
  taxa = "Taxa",
  micom = "Micom",
  pathway = "Pathway",
  metabo = "Metabolomics",
  all = "All"
)

# Build individual Venn + title grobs
venn_grobs <- lapply(selected_omics, function(omic) {
  display_name <- display_names[[omic]]  # Get mapped display name
  grobTree(
    grid.text(paste(toupper(display_name), "Models"),
              x = 0.5, y = 0.90,
              gp = gpar(fontsize = 12, fontface = "bold", fontfamily = "Arial")),
    venn_plots_4_[[omic]]
  )
})
# Create overall title as a grob
main_title <- textGrob(
  "Overlap of Top Feature Across Omic Models",
  gp = gpar(fontsize = 16, fontface = "bold", fontfamily = "Arial")
)

# Combine title and grid of plots
combined_plot <- arrangeGrob(
  do.call(arrangeGrob, c(venn_grobs, nrow = 2, ncol = 3)),
  top = main_title
)

# Draw on a new page
grid.newpage()
grid.draw(combined_plot)

file_path <- file.path(omic_out_dir, "venns/venn_grid_overall_title.png")
png(file_path, width = 3000, height = 2000, res = 300)
grid.draw(combined_plot)
dev.off()

```


```{r echo=FALSE, fig.asp = 1.2, fig.width=10, out.width="90%"}
g1 <- grobTree(venn_plots_4_$basic)
g2 <- grobTree(venn_plots_4_$meta)
g3 <- grobTree(venn_plots_4_$taxa)
g4 <- grobTree(venn_plots_4_$micom)
g5 <- grobTree(venn_plots_4_$metabo)
g6 <- grobTree(venn_plots_4_$all)

# Create a 2-column layout with 3 rows + spacers
p <- arrangeGrob(
  arrangeGrob(g1, g2, ncol = 2),
  spacer <- rectGrob(gp = gpar(col = NA)),
  arrangeGrob(g3, g4, ncol = 2),
  spacer,
  arrangeGrob(g5, g6, ncol = 2),
  ncol = 1,
  widths = unit(1, "null"),
  heights = unit.c(unit(1, "null"), unit(1.5, "cm"),
                   unit(1, "null"), unit(1.5, "cm"),
                   unit(1, "null")))

p <- arrangeGrob(
  arrangeGrob(g1, nullGrob(), g2, ncol = 3, widths = c(0.45, 0.1, 0.45)),
  rectGrob(gp = gpar(col = NA)),  # spacer row
  arrangeGrob(g3, nullGrob(), g4, ncol = 3, widths = c(0.45, 0.1, 0.45)),
  rectGrob(gp = gpar(col = NA)),  # spacer row
  arrangeGrob(g5, nullGrob(), g6, ncol = 3, widths = c(0.45, 0.1, 0.45)),
  ncol = 1,
  heights = unit.c(
    unit(1, "null"),
    unit(1.5, "cm"),
    unit(1, "null"),
    unit(1.5, "cm"),
    unit(1, "null")
  )
)
# Display in R Markdown
grid::grid.newpage()
grid::grid.draw(p)
```


```{r}
# Define file name
png_name <- file.path(omic_out_dir, "venns/venn_combined_plot.png")
# Save the arranged plot to a PNG file
png(filename = png_name, width = 2800, height = 2800, res = 300)
grid.draw(p)
dev.off()
```



# No Longer Used 

## ANOVA Combinations

# Figure x : Combined ANOVA R2 plots for initial

```{r echo=FALSE, fig.width = 10, fig.asp = 1.05, out.width="95%", warning=FALSE}
# Combine all plots into 1
plot_names <- glue("{names(omic_dfs)}_basic_sig_plot")
sig_plots <- mget(plot_names)
merf_basic_anova_plots <- mget(plot_names[c(1,3)])
glass_basic_anova_plots <- mget(plot_names[c(2,4)])

combined_basic_plot <- wrap_plots(sig_plots, ncol = 2) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))

merf_basic_plot <- wrap_plots(merf_basic_anova_plots, ncol = 1) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))

gllass_basic_plot <- wrap_plots(glass_basic_anova_plots, ncol = 1) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))

print(combined_basic_plot)
output_file_basic <- file.path(omic_out_dir, "_ANOVA_R2_Comparison_basic.png")

# Save the plot
#ggsave(filename = output_file_basic,
#  plot = combined_basic_plot,
#  width = 15, height = 12, dpi = 400)

# Save the plots
ggsave(filename = file.path(omic_out_dir, "anova_plots/combined_basic_plot.png"),
       plot = combined_basic_plot,
       width = 15, height = 12, dpi = 400)

ggsave(filename = file.path(omic_out_dir, "anova_plots/merf_basic_plot.png"),
       plot = merf_basic_plot,
       width = 7.5, height = 10, dpi = 400)

ggsave(filename = file.path(omic_out_dir, "anova_plots/gllass_basic_plot.png"),
       plot = gllass_basic_plot,
       width = 7.5, height = 10, dpi = 400)
```

## Arrange basic and clin plus anova plots 
```{r}
# Combine all plots into 1
plot_names <- glue("{names(omic_dfs)}_basic_sig_plot")
sig_plots <- mget(plot_names)
combined_plot <- wrap_plots(sig_plots, ncol = 2) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))

output_file <- file.path(omic_out_dir, "ANOVA_Marginal_R2_Comparison_initial_with_grs.png")

# Save the plot
# ggsave(filename = output_file, plot = combined_plot,
#        width = 15, height = 12, dpi = 300)

plot_names_clin_plus <- glue("{names(omic_dfs)}_sig_plot_clin_plus")

sig_plots_clin_plus <- mget(plot_names_clin_plus)
merf_plots_clin_plus <- mget(plot_names_clin_plus[c(1,3)])
glmmlasso_clin_plus <- mget(plot_names_clin_plus[c(2,4)])

combined_sig_plot_clin_plus <- wrap_plots(sig_plots_clin_plus, ncol = 2) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, 
                                                          face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))

merfs_sig_plot_clin_plus <- wrap_plots(merf_plots_clin_plus, ncol = 1) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, 
                                                          face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))

glmmlasso_sig_plot_clin_plus <- wrap_plots(glmmlasso_clin_plus, ncol = 1) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, 
                                                          face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))


ggsave(filename = file.path(omic_out_dir, "anova_plots/combined_clin_plot.png"),
       plot = combined_sig_plot_clin_plus,
       width = 15, height = 12, dpi = 400)

ggsave(filename = file.path(omic_out_dir, "anova_plots/merf_clin_plot.png"),
       plot = merfs_sig_plot_clin_plus,
       width = 7.5, height = 10, dpi = 400)

ggsave(filename = file.path(omic_out_dir, "anova_plots/gllass_clin_plot.png"),
       plot = glmmlasso_sig_plot_clin_plus,
       width = 7.5, height = 10, dpi = 400)

output_file_sig_plot_clin_plus <- file.path(omic_out_dir, 
                                            "ANOVA_Marginal_R2_Comparison_sig_plot_clin_plus.png")

# Save the plot
ggsave(filename = output_file_sig_plot_clin_plus,
       plot = combined_sig_plot_clin_plus, width = 15, height = 12, dpi = 300)

### together 
all_sig_plots <- c(sig_plots, sig_plots_clin_plus) # Combine both lists

# Combine into one grid with 4 columns and 2 rows
combined_all_plots <- wrap_plots(all_sig_plots, ncol = 4) +
  plot_annotation(
    title = "Comparison of Marginal R² Across BMI Modeling Scores",
    tag_levels = 'A',tag_suffix = '.',
    theme = theme(plot.title = element_text(size = 18, face = "bold"))) &
    theme(plot.margin = ggplot2::margin(20, 10, 20, 3, unit = "pt"))

# Save to file
output_file_combined <- file.path(omic_out_dir, "anova_plots/Combined_ANOVA_Marginal_R2_base_clin.png")

ggsave(filename = output_file_combined, plot = combined_all_plots,
       width = 20, height = 10, dpi = 600)

```

# For 4 figures set up ANOVAs 
```{r}
# MERF & GLLASSO Basic Long 
basic_long <- mget(plot_names[c(1,2)])

basic_long_plt <- wrap_plots(basic_long, ncol = 1) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, 
                                                          face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))
basic_long_plt
# MERF & GLLASSO Basic Delta
basic_delta <- mget(plot_names[c(3,4)])

basic_delta_plt <- wrap_plots(basic_delta, ncol = 1) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, 
                                                          face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))

# MERF & GLLASSO Clinical Long
clin_long <- mget(plot_names_clin_plus[c(1,2)])

clin_long_plt <- wrap_plots(clin_long, ncol = 1) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, 
                                                          face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))

# MERF & GLLASSO Clinical Delta
clin_delta <- mget(plot_names_clin_plus[c(3,4)])

clin_delta_plt <- wrap_plots(clin_delta, ncol = 1) + 
  plot_annotation(title = "Comparison of Marginal R² Across BMI Modeling Scores", 
                  theme = theme(plot.title = element_text(size = 18, 
                                                          face = "bold"))) &
                  theme(plot.margin = ggplot2::margin(20, 20, 20, 20, unit = "pt"))

# Save Basic Long plot
ggsave("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/april/anova_results/plots/paper_render/basic_plus_diet/anova_plots/long_basic/basic_long_plt.png", plot = basic_long_plt, width = 8, height = 10, dpi = 300)
# Save Basic Delta plot
ggsave("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/april/anova_results/plots/paper_render/basic_plus_diet/anova_plots/delta_basic/basic_delta_plt.png", plot = basic_delta_plt, width = 8, height = 10, dpi = 300)
# Save Clinical Long plot
ggsave("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/april/anova_results/plots/paper_render/basic_plus_diet/anova_plots/long_clin/clin_long_plt.png", plot = clin_long_plt, width = 8, height = 10, dpi = 300)
# Save Clinical Delta plot
ggsave("/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions/play_scripts/2.models/merf_python/april/anova_results/plots/paper_render/basic_plus_diet/anova_plots/delta_clin/clin_delta_plt.png", plot = clin_delta_plt, width = 8, height = 10, dpi = 300)
```


## Merf plots combinations 

```{r}
#theme(plot.margin = margin(t = 10, r = 15, b = 10, l = 10, unit = "pt"))

# Merf long: Clinical, Grs, Pathway, Metabo, All
merf_long_plots <- merf_plots[c(2, 3, 6, 7, 8)]
combined_merf_long_plot <- wrap_plots(merf_long_plots, ncol = 2, nrow = 3, 
                                      #widths = c(0.95,0.95),
                                      heights = c(0.95,0.95)) +
                           #plot_annotation(title = "MERF longitudinal BMI Prediction Features",
                           #theme = theme(plot.title = element_text(size = 25, face = "bold"))) &
                           theme(plot.margin = ggplot2::margin(t = 10, r = 5, b = 10, l = 3, unit = "pt"))

basic_merf_long <- merf_plots[c(2, 3, 6, 7, 8)]
basic_merf_long_plot <- wrap_plots(basic_merf_long, ncol = 2, nrow = 3, 
                                      #widths = c(0.95,0.95),
                                      heights = c(0.95,0.95)) +
                           #plot_annotation(title = "MERF longitudinal BMI Prediction Features",
                           #theme = theme(plot.title = element_text(size = 25, face = "bold"))) &
                           theme(plot.margin = ggplot2::margin(t = 10, r = 5, b = 10, l = 3, unit = "pt"))


clin_merf_long <- merf_plots[c(7, 8)]
clin_merf_long_plot <- wrap_plots(clin_merf_long, ncol = 2, nrow = 2, 
                                      #widths = c(0.95,0.95),
                                      heights = c(0.95,0.95)) +
                           #plot_annotation(title = "MERF longitudinal BMI Prediction Features",
                           #theme = theme(plot.title = element_text(size = 25, face = "bold"))) &
                           theme(plot.margin = ggplot2::margin(t = 10, r = 5, b = 10, l = 3, unit = "pt"))

# Merf delta: Clinical, Taxa, Meta, All
merf_delta_plots <- merf_plots[c(10, 12, 15, 16)]
combined_merf_delta_plot <- wrap_plots(merf_delta_plots, ncol = 1, nrow = 4,
                                       #widths = c(0.95,0.95),
                                       heights = c(0.95,0.95)) +
                            #plot_annotation(title = "MERF BMI Change Prediction Features",
                            #theme = theme(plot.title = element_text(size = 25, face = "bold"))) &
                            theme(plot.margin = ggplot2::margin(t = 10, r = 5, b = 10, l = 3, unit = "pt"))

basic_merf_delta <- merf_plots[c(10, 12, 15, 16)]
basic_merf_delta_plot <- wrap_plots(basic_merf_delta, ncol = 1, nrow = 4,
                                       #widths = c(0.95,0.95),
                                       heights = c(0.95,0.95)) +
                            #plot_annotation(title = "MERF BMI Change Prediction Features",
                            #theme = theme(plot.title = element_text(size = 25, face = "bold"))) &
                            theme(plot.margin = ggplot2::margin(t = 10, r = 5, b = 10, l = 3, unit = "pt"))

clin_merf_delta <- merf_plots[c(12, 15, 16)]
clin_merf_delta_plot <- wrap_plots(clin_merf_delta, ncol = 1, nrow = 3,
                                       #widths = c(0.95,0.95),
                                       heights = c(0.95,0.95)) +
                            #plot_annotation(title = "MERF BMI Change Prediction Features",
                            #theme = theme(plot.title = element_text(size = 25, face = "bold"))) &
                            theme(plot.margin = ggplot2::margin(t = 10, r = 5, b = 10, l = 3, unit = "pt"))

# Merf ALl
merf_all_plots <- merf_plots[c(2, 3, 6, 7, 8, 10, 12, 15, 16)]
combined_merf_all_plot <- wrap_plots(merf_all_plots, ncol = 3, nrow = 3,
                                       widths = c(0.95, 0.95, 0.95),
                                       heights = c(0.90, 0.90, 0.90),
                                       tag_level = "keep") +
                            plot_annotation(title = "All MERF Prediction Features",
                            theme = theme(plot.title = element_text(size = 40, face = "bold"))) &
                            theme(plot.margin = ggplot2::margin(t = 10, r = 5, b = 10, l = 3, unit = "pt"))

print(combined_merf_delta_plot)
print(combined_merf_long_plot)
print(combined_merf_all_plot)
```


```{r}
for (i in seq_along(merf_plots)) {
  ggsave(
    filename = file.path(omic_out_dir, paste0("merf_ft_imp/merf_plot_dot_", i, ".png")),
    plot = merf_plots[[i]],
    width = 8,
    height = 4,
    dpi = 300)
}

png_name1 <- file.path(omic_out_dir, paste0("merf_ft_imp/combined_merf_long_ft_plot_dot", ".png"))
ggsave(filename = png_name1, plot = combined_merf_long_plot, width = 20, height = 30, dpi = 600)

png_name2 <- file.path(omic_out_dir, paste0("merf_ft_imp/combined_merf_delta_ft_plot_dot", ".png"))
ggsave(filename = png_name2, plot = combined_merf_delta_plot, width = 20, height = 30, dpi = 600)

png_name3 <- file.path(omic_out_dir, paste0("merf_ft_imp/combined_merf_all_ft_plot_dot", ".png"))
ggsave(filename = png_name3, plot = combined_merf_all_plot, width = 45, height = 30, dpi = 600)
```

```{r}
merf_cow_plot_ft <- cowplot::plot_grid(
  combined_merf_long_plot,
  combined_merf_delta_plot,
  ncol = 2,
  labels = c("A", "B"),
  label_size = 25,
  align = "hv",
  axis = "tblr",  # Align both top/bottom and left/right axes
  rel_widths = c(0.97, 0.97),
  scale = c(.97, .97))

merf_cow_plot_ft

ggsave(paste0(omic_out_dir, "merf_ft_imp/merf_ft_plot_combined_all.png"), merf_cow_plot_ft, 
       width = 45, height = 20, dpi = 400, bg = 'white')
```

## Lass plots combinations

```{r}
lass_long_plots <- lass_plots_lg[c(2,3,7)]
combined_lass_long_plot <- wrap_plots(lass_long_plots, ncol = 1) +
  plot_annotation(title = "GlmmLasso longitudinal BMI Prediction Features",
                  theme = theme(plot.title = element_text(size = 18, face = "bold"))) &
  theme(plot.margin = ggplot2::margin(10, 10, 10, 10, unit = "pt"))

basic_lass_long <- lass_plots_lg[c(2,7)]
basic_lass_long_plot <- wrap_plots(basic_lass_long, ncol = 1) +
  #plot_annotation(title = "GlmmLasso longitudinal BMI Prediction Features",
  #                theme = theme(plot.title = element_text(size = 18, face = "bold"))) &
  theme(plot.margin = ggplot2::margin(10, 10, 10, 10, unit = "pt"))

basic_lass_long_plot <- wrap_plots(
  basic_lass_long[[1]],
  plot_spacer(),
  basic_lass_long[[2]],
  ncol = 1,
  heights = c(1, 0.1, 1)) &
theme(plot.margin = ggplot2::margin(10, 10, 10, 10, unit = "pt"))

clin_lass_long_plot <- wrap_plots(
  combined_lass_long_plot[[1]],
  plot_spacer(),  # adds blank vertical space
  combined_lass_long_plot[[2]],
  ncol = 1,
  heights = c(1, 0.1, 1)) &
theme(plot.margin = ggplot2::margin(10, 10, 10, 10, unit = "pt"))

png_name <- file.path(omic_out_dir, paste0("lass_ft_imp/combined_lass_long_ft_plot", ".png"))
ggsave(filename = png_name, 
       plot = combined_lass_long_plot, 
       width = 16, height = 20, dpi = 300)
combined_lass_long_plot
```


```{r}
lass_delta_plots <- lass_plots_delta[c(2, 7, 8)]
combined_lass_delta_plot <- wrap_plots(lass_delta_plots, ncol = 1) +
  plot_annotation(title = "GlmmLasso BMI Change Prediction Features",
                  theme = theme(plot.title = element_text(size = 18, face = "bold"))) &
  theme(plot.margin = ggplot2::margin(10, 10, 10, 10, unit = "pt"))

basic_lass_delta <- lass_plots_delta[c(2, 7)]
basic_lass_delta_plot <- wrap_plots(basic_lass_delta, ncol = 1) +
  #plot_annotation(title = "GlmmLasso BMI Change Prediction Features",
  #                theme = theme(plot.title = element_text(size = 18, face = "bold"))) &
  theme(plot.margin = ggplot2::margin(10, 10, 10, 10, unit = "pt"))

clin_lass_delta <- lass_plots_delta[c(7)]
clin_lass_delta_plot <- wrap_plots(clin_lass_delta, ncol = 1) +
  theme(panel.border = element_blank(),  
    plot.background  = element_blank(),
    panel.background = element_blank(),
    plot.margin = ggplot2::margin(10, 10, 10, 10, unit = "pt"))

png_name <- file.path(omic_out_dir, paste0("lass_ft_imp/combined_lass_delta_ft_plot", ".png"))
ggsave(filename = png_name, plot = combined_lass_delta_plot, width = 16, height = 20, dpi = 300)
```


```{r fig.width = 12, fig.asp = 0.8, out.width="90%"}
lass_cow_plot_ft <- cowplot::plot_grid(
  combined_lass_long_plot,
  combined_lass_delta_plot,
  ncol = 2,
  labels = c("A", "B"),
  label_size = 12,
  align = "hv",
  axis = "tblr",  # Align both top/bottom and left/right axes
  rel_widths = c(.95, .95),
  scale = c(.95, .95))

lass_cow_plot_ft

ggsave(paste0(omic_out_dir, "lass_ft_imp/lasso_ft_plot_all_combined.png"), lass_cow_plot_ft, 
       width = 40, height = 22.5, dpi = 600, bg = 'white')
```
