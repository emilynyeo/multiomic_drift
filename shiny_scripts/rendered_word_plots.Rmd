---
title: "Paper plots for render"
author: "Emily Yeo"
date: "`r Sys.Date()`"
output: 
  officedown::rdocx_document:
    #reference_docx: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	fig.cap = TRUE,
	message = FALSE,
	include = FALSE)

rm(list = ls())

base_dir <- "/Users/emily/projects/research/Stanislawski/comps/mutli-omic-predictions"
source(file.path(base_dir, "shiny_scripts/plotting_utils.R"))
source(file.path(base_dir, "shiny_scripts/plot_input_data.R"))
```

```{r include=FALSE}
# Set output directories
omic_out_dir <- file.path(base_dir, "paper_plots")
venn_dir <- file.path(base_dir, "paper_plots")

# Create output subdirectories if they don't exist
output_dirs <- c("shap", "anova_tables", "aov_feats_combined", "venns", "lass_ft_imp")
for (dir in output_dirs) {
  dir.create(file.path(omic_out_dir, dir), recursive = TRUE, showWarnings = FALSE)
}
```


```{r}
# Color palettes
cluster_palette_contrast <- c(
  "#004E64", "#B0E0E6", "#4682B4", "#2F4F4F", "#556B2F", "#6B8E23",
  "#708090", "#A9CBB7", "#F0E68C", "#E6BE8A", "#FFF5E1", "#B5A642")

# Main feature type colors
ft_colors <- c(
  Clinical     = "#fbbdd1",
  Taxa         = "#8B3A3A",
  Micom        = "#996759",
  Pathway      = "#D8A39D",
  Metabolomics = "#C76374",
  Combined     = "#b44241",
  GRS          = "#E18476",
  Basic        = "#582F2B")
```

# SHAP Plots for Long 
```{r}
title_map <- c(
  shap_long_micom      = "MERF Long Micom",
  shap_long_basic      = "MERF Long Basic",
  shap_long_all      = "MERF Long All",
  shap_long_metabo   = "MERF Long Metabolomics",
  shap_long_grs      = "MERF Long GRS",
  shap_long_pathway  = "MERF Long Pathway",
  shap_long_taxa     = "MERF Long Taxonomy",
  shap_long_meta     = "MERF Long Clinical")

shap_long_plot_list <- list()
heights_vec <- numeric(0)

for (name in names(shap_dfs)) {
  df <- shap_dfs[[name]]

  # Determine group for color mapping
  group_key <- case_when(
    grepl("meta$", name)      ~ "Clinical",
    grepl("taxa$", name)      ~ "Taxa",
    grepl("micom$", name)     ~ "Micom",
    grepl("pathway$", name)   ~ "Pathway",
    grepl("metabo$", name)    ~ "Metabolomics",
    grepl("all$", name)       ~ "Combined",
    grepl("grs$", name)       ~ "GRS",
    grepl("basic$", name)     ~ "Basic",
    TRUE ~ "Combined")
  
  high_col <- ft_colors[[group_key]]

  # Count features & limit to top 10
  top_features <- df %>%
    filter(Feature != "time") %>%
    group_by(Feature) %>%
    summarise(max_abs_shap = max(abs(SHAP), na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(max_abs_shap)) %>%
    slice_head(n = 10) %>%
    pull(Feature)
  
  df_top10 <- df %>% filter(Feature %in% top_features)

  # Calculate height
  n_features <- length(unique(df_top10$Feature))
  heights_vec <- c(heights_vec, n_features + 2)

  # Create plot
  plot_title <- title_map[[name]]
  
  p <- plot_shap_beeswarm(df_top10, plot_title, high_color = "#b44241") +
        combined_plot_theme(base_size = 16) +
        theme(plot.margin = ggplot2::margin(10, 10, 10, 10))
  
  shap_long_plot_list[[name]] <- p
}

# Normalize heights to sum to 1
heights_norm <- heights_vec / sum(heights_vec)
combined_shap_long <- wrap_plots(shap_long_plot_list,  # Combine vertically
                                 ncol = 1, heights = heights_norm)

# Save large PDF
ggsave(
  filename = file.path(omic_out_dir, "shap/all_shap_plots_combined_abs.pdf"),
  plot = combined_shap_long,
  width = 18,
  height = sum(heights_vec) * 0.5,
  units = "in",
  limitsize = FALSE)
```


## SHAP Delta Plots

```{r}
title_map_delta <- c(
  shap_delta_micom    = "MERF Delta Micom",
  shap_delta_basic    = "MERF Delta Basic",
  shap_delta_all      = "MERF Delta All",
  shap_delta_metabo   = "MERF Delta Metabolomics",
  shap_delta_grs      = "MERF Delta GRS",
  shap_delta_pathway  = "MERF Delta Pathway",
  shap_delta_taxa     = "MERF Delta Taxonomy",
  shap_delta_meta     = "MERF Delta Clinical")

shap_delta_plot_list <- list()
heights_vec <- numeric(0)

for (name in names(shap_delta_dfs)) {
  df <- shap_delta_dfs[[name]]

  # Determine group for color mapping
  group_key <- case_when(
    grepl("meta$", name)      ~ "Clinical",
    grepl("taxa$", name)      ~ "Taxa",
    grepl("micom$", name)     ~ "Micom",
    grepl("pathway$", name)   ~ "Pathway",
    grepl("metabo$", name)    ~ "Metabolomics",
    grepl("all$", name)       ~ "Combined",
    grepl("grs$", name)       ~ "GRS",
    grepl("basic$", name)     ~ "Basic",
    TRUE ~ "Combined")
  high_col <- ft_colors[[group_key]]

  # Count features & limit to top 10
  top_features <- df %>%
    filter(Feature != "time") %>%
    group_by(Feature) %>%
    summarise(max_abs_shap = max(abs(SHAP), na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(max_abs_shap)) %>%
    slice_head(n = 10) %>%
    pull(Feature)
  df_top10 <- df %>% filter(Feature %in% top_features)

  # Calculate height
  n_features <- length(unique(df_top10$Feature))
  heights_vec <- c(heights_vec, n_features + 2)

  # Create plot
  plot_title <- title_map_delta[[name]]
  
  p <- plot_shap_beeswarm(df_top10, plot_title, high_color = "#b44241") +
        combined_plot_theme(base_size = 16) +
        theme(plot.margin = ggplot2::margin(10, 10, 10, 10))
  
  shap_delta_plot_list[[name]] <- p
}

# Normalize heights to sum to 1
heights_norm <- heights_vec / sum(heights_vec)
combined_shap_delta <- wrap_plots(shap_delta_plot_list,  # Combine vertically
                                 ncol = 1, heights = heights_norm)

# Save large PDF
ggsave(
  filename = file.path(omic_out_dir, "shap/all_delta_shap_plots_combined_abs.pdf"),
  plot = combined_shap_delta,
  width = 18,
  height = sum(heights_vec) * 0.5,
  units = "in",
  limitsize = FALSE)

```

### lmer and anova set up for basic score comparisons

```{r}
# Setup and modeling for each omic
omic_dfs <- list(
  merf_long = merf_long,
  gl_lasso_long = gl_lasso_long,
  merf_delta = merf_delta, 
  gl_lasso_delta = gl_lasso_delta)

omic_name_labels <- c(
  "merf_long"      = "MERF BMI",
  "gl_lasso_long"  = "GlmmLasso BMI",
  "merf_delta"     = "MERF ΔBMI",
  "gl_lasso_delta" = "GlmmLasso ΔBMI")

# Create containers for later use
all_r2_dfs <- list()
all_anova_labels <- list()

for (omic_name in names(omic_dfs)) {
  print(glue::glue("Running for: {omic_name}"))
  omic <- omic_dfs[[omic_name]]
  
  ## Fit LMER Models on scores 
  lmer_basic <- lmer(bmi ~ y_new_basic + (1|Cluster), data = omic, REML = FALSE)
  lmer_meta_b <- lmer(bmi ~ y_new_basic + y_new_meta + (1|Cluster), data = omic, REML = FALSE)
  lmer_grs_b <- lmer(bmi ~ y_new_basic + y_new_grs + (1|Cluster), data = omic, REML = FALSE)
  lmer_micom_b <- lmer(bmi ~ y_new_basic + y_new_micom + (1|Cluster), data = omic, REML = FALSE)
  lmer_path_b <- lmer(bmi ~ y_new_basic + y_new_pathway + (1|Cluster), data = omic, REML = FALSE)
  lmer_tax_b <- lmer(bmi ~ y_new_basic + y_new_taxa + (1|Cluster), data = omic, REML = FALSE)
  lmer_metabo_b <- lmer(bmi ~ y_new_basic + y_new_metabo + (1|Cluster), data = omic, REML = FALSE)
  lmer_all_b <- lmer(bmi ~ y_new_basic + y_new_all + (1|Cluster), data = omic, REML = FALSE)

  models <- list(
    Basic = lmer_basic,
    `Basic + Clinical` = lmer_meta_b,
    `Basic + GRS` = lmer_grs_b,
    `Basic + Micom` = lmer_micom_b,
    `Basic + Pathway` = lmer_path_b,
    `Basic + Taxa` = lmer_tax_b,
    `Basic + Metabolomics` = lmer_metabo_b,
    `Basic + Combined` = lmer_all_b)

  # Extract RÂ² values
  r2_df <- do.call(rbind, lapply(names(models), function(name) {
    r2_vals <- r.squaredGLMM(models[[name]])
    data.frame(Model = name, R2m = r2_vals[1, "R2m"], R2c = r2_vals[1, "R2c"])
  }))

  assign(paste0(omic_name, "_r2_df"), r2_df)
  all_r2_dfs[[omic_name]] <- r2_df

  ##  ANOVA 
  comparisons <- list(
    c("lmer_basic", "lmer_meta_b"),
    c("lmer_basic", "lmer_grs_b"),
    c("lmer_basic", "lmer_tax_b"),
    c("lmer_basic", "lmer_micom_b"),
    c("lmer_basic", "lmer_path_b"),
    c("lmer_basic", "lmer_metabo_b"),
    c("lmer_basic", "lmer_all_b"))

  # Store all models in global environment (needed for `get()`)
  list2env(models, envir = .GlobalEnv)

  anova_results <- list()
  for (pair in comparisons) {
    model_1 <- get(pair[1])
    model_2 <- get(pair[2])
    anova_out <- anova(model_1, model_2)
    anova_out <- as.data.frame(anova_out)
    anova_out$model_comparison <- paste(pair[1], "vs", pair[2])
    anova_results[[length(anova_results) + 1]] <- anova_out
  }

  anova_table <- do.call(rbind, anova_results) %>%
    filter(!is.na(`Chisq`) & !is.na(`Pr(>Chisq)`)) %>%
    mutate(across(where(is.numeric), \(x) round(x, 3))) %>% 
    dplyr::select(-npar)
  rownames(anova_table) <- NULL

  # Annotate comparisons
  anova_labels <- anova_table %>%
    dplyr::mutate(Compared_Model = dplyr::recode(model_comparison,
        "lmer_basic vs lmer_meta_b" = "Basic + Clinical",
        "lmer_basic vs lmer_grs_b" = "Basic + GRS",
        "lmer_basic vs lmer_tax_b" = "Basic + Taxa",
        "lmer_basic vs lmer_micom_b" = "Basic + Micom",
        "lmer_basic vs lmer_path_b" = "Basic + Pathway",
        "lmer_basic vs lmer_metabo_b" = "Basic + Metabolomics",
        "lmer_basic vs lmer_all_b" = "Basic + Combined"),
      Significance = case_when(
        `Pr(>Chisq)` < 0.001 ~ "***",
        `Pr(>Chisq)` < 0.01  ~ "**",
        `Pr(>Chisq)` < 0.05  ~ "*",
        TRUE ~ ""),
      `Pr(>Chisq)` = case_when(
        `Pr(>Chisq)` < 0.001 ~ "<0.001",
        `Pr(>Chisq)` < 0.01 ~ "<0.01",
        TRUE ~ as.character(`Pr(>Chisq)`)))

  all_anova_labels[[omic_name]] <- anova_labels
}
```

## Predicted vs. actual BMI 

```{r}
for (omic_name in names(omic_dfs)) {
  omic <- omic_dfs[[omic_name]]
  pred_data <- omic

  cluster_palette <- cluster_palette_contrast[1:12]

  gl_long <- pred_data %>%
    pivot_longer(cols = starts_with("y_new"), 
                 names_to = "predictor_type", 
                 values_to = "prediction") %>%
    mutate(Time = as.factor(Time))

  long_plot <- ggplot(gl_long, aes(x = bmi, y = prediction, color = predictor_type)) +
    geom_point(alpha = 0.6, size = 1) +
    geom_smooth(method = "lm", se = FALSE, size = 1.25) +
    scale_color_manual(values = cluster_palette) +
    labs(title = glue("{omic_name_labels[[omic_name]]} Predicted BMI Values vs. Actual BMI"),
         x = "Actual Test Set BMI", y = "Omic Risk Score Predicted BMI", color = "Predictor") +
    theme_minimal()

  print(long_plot)
}
```

## ANOVA results GT table 

For basic model comparisons 

```{r}
for (omic_name in names(all_r2_dfs)) {
  r2_df <- all_r2_dfs[[omic_name]]
  anova_labels <- all_anova_labels[[omic_name]]
  
  # Merge with R2 table
  r2_annotated <- left_join(r2_df, anova_labels, 
                            by = c("Model" = "Compared_Model"))
  
  # Fill AIC for Basic model
  basic_model <- get("lmer_basic")
  basic_aic <- AIC(basic_model)
  
  r2_annotated <- r2_annotated %>%
    mutate(AIC = ifelse(Model == "Basic", round(basic_aic, 3), AIC))

  # Format table
  final_table <- r2_annotated %>%
    dplyr::select(-R2c, -BIC, -logLik, -Df, -model_comparison, -`-2*log(L)`) %>%
    rename("RÂ²*" = R2m, "P-Value" = `Pr(>Chisq)`) %>%
    gt() %>%
    tab_header(title = "Model Comparison (ANOVA)") %>%
    fmt_number(columns = where(is.numeric), decimals = 2) %>%
    sub_missing(missing_text = "-") %>%
    cols_align("center", columns = everything()) %>%
    cols_align("left", columns = Model) %>%
    cols_width(1 ~ pct(20),
               `RÂ²*` ~ pct(15), 
              Significance ~ pct(15),
              `P-Value` ~ pct(15), 
              AIC ~ pct(11), 
              Significance ~ pct(11)) %>%
    tab_options(table.width = pct(60), table.align = "center") %>%
    opt_table_font(font = list(google_font("Arial"), default_fonts())) %>%
    tab_style(style = cell_text(weight = "bold"), locations = cells_column_labels())

  assign(paste0(omic_name, "_anova_table"), final_table)
  print(final_table)
}
```


## ANOVA Sig Plots for basic 

```{r}
delta_labels <- c(
  "Basic" = "Δ Basic",
  "Basic + Clinical" = "+ Δ Clinical",
  "Basic + GRS" = "+ Δ GRS",
  "Basic + Pathway" = "+ Δ Pathway",
  "Basic + Taxa" = "+ Δ Taxa",
  "Basic + Micom" = "+ Δ Micom",
  "Basic + Metabolomics" = "+ Δ Metabolomics",
  "Basic + Combined" = "+ Δ Combined")

long_labels <- c(
  "Basic" = " Basic",
  "Basic + Clinical" = "+ Clinical",
  "Basic + GRS" = "+ GRS",
  "Basic + Pathway" = "+ Pathway",
  "Basic + Taxa" = "+ Taxa",
  "Basic + Micom" = "+ Micom",
  "Basic + Metabolomics" = "+ Metabolomics",
  "Basic + Combined" = "+ Combined")

for (omic_name in names(all_r2_dfs)) {
  r2_df <- all_r2_dfs[[omic_name]]
  anova_labels <- all_anova_labels[[omic_name]]
  
  # Merge R2 with significance labels
  r2_annotated <- left_join(r2_df, anova_labels, by = c("Model" = "Compared_Model"))

  # Set custom model order
  custom_order <- c("Basic", "Basic + Clinical", "Basic + GRS", "Basic + Pathway",
                    "Basic + Taxa", "Basic + Micom", 
                    "Basic + Metabolomics", "Basic + Combined")
  fill_vals <- setNames(sapply(custom_order, get_color), custom_order)
  r2_annotated$Model <- factor(r2_annotated$Model, levels = custom_order)

  # Fill in AIC for "Basic" model if missing
  basic_model <- get("lmer_basic")
  basic_aic <- AIC(basic_model)
  r2_annotated <- r2_annotated %>%
    mutate(AIC = ifelse(Model == "Basic", round(basic_aic, 3), AIC))

  # Extract R² for horizontal line
  basic_r2 <- r2_annotated$R2m[r2_annotated$Model == "Basic"]

  # Select correct label set
  label_set <- if (omic_name %in% c("gl_lasso_delta", "merf_delta")) {
    delta_labels
  } else if (omic_name %in% c("gl_lasso_long", "merf_long")) {
    long_labels
  } else {
    NULL  
  }

  # Bar plot
  sig_plot <- ggplot(r2_annotated, aes(x = Model, y = R2m, fill = Model)) +
    geom_col(width = 0.7, color = "white", size = 0.5) +
    geom_text(aes(y = R2m + 0.03, label = Significance), size = 8, color = "black", fontface = "bold") +
    scale_y_continuous(limits = c(0, 0.6), expand = expansion(mult = c(0, 0.1))) +
    scale_fill_manual(values = fill_vals) +
    scale_x_discrete(labels = label_set) +  
    #labs(title = glue("{omic_name_labels[[omic_name]]}"),
    labs(title = NULL,
         x = NULL,
         y = expression("Marginal " ~ R^2)) +
    combined_plot_theme(base_size = 16)

  print(sig_plot)
  assign(paste0(omic_name, "_sig_plot"), sig_plot)
}

```


# Combined ANOVA table for Basic score comparisons 

```{r echo=FALSE, fig.width = 5, fig.asp = 1, out.width="70%"}
# Assuming you saved the cleaned data frames *before* turning them into gt tables:
all_anova_clean_tables <- list(
  merf_long    = merf_long_anova_table,
  gl_lasso_long = gl_lasso_long_anova_table,
  merf_delta    = merf_delta_anova_table,
  gl_lasso_delta = gl_lasso_delta_anova_table)

raw_tables <- lapply(all_anova_clean_tables, function(gt_obj) gt_obj[["_data"]])

combined_anova_df <- bind_rows(
  lapply(names(raw_tables), function(name) {
    df <- raw_tables[[name]]
    df$Model_Type <- name
    df
    }),
  .id = "Source")

# Combined ANOVA table
final_anova_table_initial <- combined_anova_df %>% 
  dplyr::select(-c("Source")) %>% 
  mutate(Model_Type = dplyr::case_when(
    Model_Type == "merf_long" ~ "MERF Longitudinal BMI prediction",
    Model_Type == "gl_lasso_long" ~ "GlmmLasso BMI Prediction",
    Model_Type == "merf_delta" ~ "MERF ΔBMI Prediction)",
    Model_Type == "gl_lasso_delta" ~ "GlmmLasso ΔBMI Prediction)",
    TRUE ~ Model_Type)) %>% 
  gt(groupname_col = "Model_Type") %>%
    tab_header(title = "Additive Model Comparison's (ANOVA)") %>%
    fmt_number(columns = where(is.numeric), decimals = 3) %>%
    sub_missing(missing_text = "-") %>%
    cols_width(1 ~ pct(16),
               `RÂ²*` ~ pct(12), Significance ~ pct(12),
               `P-Value` ~ pct(12), AIC ~ pct(12), 
               Significance ~ pct(12), Model_Type ~ pct(12)) %>%
    cols_align(align = "center", columns = everything()) %>% 
    cols_align("left", columns = Model) %>%
    tab_options(table.width = pct(90), table.align = "center") %>%
    opt_table_font(font = list(google_font("Arial"), default_fonts())) %>%
    tab_style(style = cell_text(weight = "bold"), 
              locations = cells_column_labels()) %>% 
    tab_style(style = list(
    cell_fill(color = "lightgray"),
    cell_text(weight = "bold",
              size = 12)),
  locations = cells_row_groups())

final_anova_table_initial
gtsave(final_anova_table_initial, 
       filename = paste0(omic_out_dir, "/anova_tables/anova_initial_table_with_grs.png"))
```

## Another ANOVA initial combination As a word doc for convenience 

```{r}
# Function to create Word documents from tables
create_word_doc <- function(tables, filename) {
  doc <- read_docx()
  for (name in names(tables)) {
    table_data <- tables[[name]]
    
    ft <- flextable(table_data) %>%
      autofit() %>%
      theme_vanilla() %>%
      set_caption(caption = name) %>%
      fontsize(size = 10, part = "all") %>%
      align(align = "center", part = "all") %>%
      border_remove() %>%
      border_outer(border = fp_border(color = "black", width = 1)) %>%
      border_inner(border = fp_border(color = "gray", width = 0.5))

    doc <- doc %>%
      body_add_par(name, style = "heading 2") %>%
      body_add_flextable(ft) %>%
      body_add_par("", style = "Normal")
  }
  print(doc, target = paste0(omic_out_dir, "/anova_tables/", filename))
}

create_word_doc(raw_tables, "anova_initial_combined.docx")
```


################################################################################

# DO we see and improvement in the omics upon CLINICAL models

Set up Omic Clinical Data and Models 

```{r}
omic_dfs <- list(
  merf_long = merf_long,
  gl_lasso_long = gl_lasso_long,
  merf_delta = merf_delta, 
  gl_lasso_delta = gl_lasso_delta)

omic_name_labels <- c(
  "merf_long"      = "MERF",
  "gl_lasso_long"  = "GlmmLasso",
  "merf_delta"     = "MERF",
  "gl_lasso_delta" = "GlmmLasso")

# Fit models and get R squared 
for (omic_name in names(omic_dfs)) {
  omic <- omic_dfs[[omic_name]]
  mod_dat <- omic
  
  # Fit models
  lmer_basic_b       <- lmer(bmi ~ y_new_basic + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_basic_meta_b  <- lmer(bmi ~ y_new_basic + y_new_meta + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_b        <- lmer(bmi ~ y_new_meta + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_grs      <- lmer(bmi ~ y_new_meta + y_new_grs + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_micom    <- lmer(bmi ~ y_new_meta + y_new_micom + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_pathway  <- lmer(bmi ~ y_new_meta + y_new_pathway + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_taxa     <- lmer(bmi ~ y_new_meta + y_new_taxa + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_metabo   <- lmer(bmi ~ y_new_meta + y_new_metabo + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_all      <- lmer(bmi ~ y_new_meta + y_new_all + (1|Cluster), data = mod_dat, REML = FALSE)

  models <- list(
    `Clinical`           = lmer_meta_b,
    `Clinical + GRS`     = lmer_meta_grs,
    `Clinical + Micom`   = lmer_meta_micom,
    `Clinical + Pathway` = lmer_meta_pathway,
    `Clinical + Taxa`    = lmer_meta_taxa,
    `Clinical + Metabolomics`  = lmer_meta_metabo,
    `Clinical + Combined`     = lmer_meta_all)

  r2_df_clin_plus <- do.call(rbind, lapply(names(models), function(name) {
    r2_vals_clin_plus <- r.squaredGLMM(models[[name]])
    data.frame(Model = name,
               R2m = r2_vals_clin_plus[1, "R2m"],
               R2c = r2_vals_clin_plus[1, "R2c"])
  }))
  assign(paste0(omic_name, "_r2_df"), r2_df_clin_plus)
}
```

Clinical Anova Table 

```{r anova_table_generation}
for (omic_name in names(omic_dfs)) {
  # Get RÂ² results and model
  r2_df_clin_plus <- get(paste0(omic_name, "_r2_df"))
  omic <- omic_dfs[[omic_name]]
  mod_dat <- omic
  
  # Fit models for this specific omic_name
  lmer_meta_b        <- lmer(bmi ~ y_new_meta + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_grs      <- lmer(bmi ~ y_new_meta + y_new_grs + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_micom    <- lmer(bmi ~ y_new_meta + y_new_micom + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_pathway  <- lmer(bmi ~ y_new_meta + y_new_pathway + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_taxa     <- lmer(bmi ~ y_new_meta + y_new_taxa + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_metabo   <- lmer(bmi ~ y_new_meta + y_new_metabo + (1|Cluster), data = mod_dat, REML = FALSE)
  lmer_meta_all      <- lmer(bmi ~ y_new_meta + y_new_all + (1|Cluster), data = mod_dat, REML = FALSE)

  lmer_models <- list(
    c("lmer_meta_b", "lmer_meta_b"),
    c("lmer_meta_b", "lmer_meta_grs"),
    c("lmer_meta_b", "lmer_meta_taxa"),
    c("lmer_meta_b", "lmer_meta_micom"),
    c("lmer_meta_b", "lmer_meta_pathway"),
    c("lmer_meta_b", "lmer_meta_metabo"),
    c("lmer_meta_b", "lmer_meta_all"))

  # Run ANOVA comparisons
  lmer_models_clin_p <- list()
  for (model_pair in lmer_models) {
    model_1 <- get(model_pair[1])
    model_2 <- get(model_pair[2])
    anova_out <- anova(model_1, model_2)
    anova_out$model_comparison <- paste(model_pair[1], "vs", model_pair[2])
    lmer_models_clin_p[[length(lmer_models_clin_p) + 1]] <- anova_out
  }

  anova_table <- do.call(rbind, lmer_models_clin_p) %>%
    filter(!is.na(`Chisq`) & !is.na(`Pr(>Chisq)`)) %>%
    mutate(across(where(is.numeric), round, 3)) %>%
    select(-npar)

  rownames(anova_table) <- NULL
  anova_table$model_1 <- gsub(" vs .*", "", anova_table$model_comparison)
  anova_table$model_2 <- gsub(".* vs ", "", anova_table$model_comparison)

  # Add significance & rename models
  anova_labels <- anova_table %>%
    mutate(
      Compared_Model = recode(model_comparison,
        "lmer_meta_b vs lmer_meta_b"     = "Clinical",
        "lmer_meta_b vs lmer_meta_grs"   = "Clinical + GRS",
        "lmer_meta_b vs lmer_meta_taxa"  = "Clinical + Taxa",
        "lmer_meta_b vs lmer_meta_micom" = "Clinical + Micom",
        "lmer_meta_b vs lmer_meta_pathway" = "Clinical + Pathway",
        "lmer_meta_b vs lmer_meta_metabo" = "Clinical + Metabolomics",
        "lmer_meta_b vs lmer_meta_all"     = "Clinical + Combined"),
      Significance = case_when(
        `Pr(>Chisq)` < 0.001 ~ "***",
        `Pr(>Chisq)` < 0.01  ~ "**",
        `Pr(>Chisq)` < 0.05  ~ "*",
        TRUE                 ~ ""),
      `Pr(>Chisq)` = case_when(
        `Pr(>Chisq)` < 0.001 ~ "<0.001",
        `Pr(>Chisq)` < 0.01  ~ "<0.01",
        TRUE ~ as.character(`Pr(>Chisq)`))) %>%
    select(Compared_Model, AIC, `Pr(>Chisq)`, Significance)

  custom_order <- c("Clinical", "Clinical + GRS", "Clinical + Pathway", 
                    "Clinical + Taxa", "Clinical + Micom", 
                    "Clinical + Metabolomics", "Clinical + Combined")
  
  clinical_aic <- AIC(lmer_meta_b)
  r2_annotated <- r2_df_clin_plus %>%
    left_join(anova_labels, by = c("Model" = "Compared_Model")) %>%
    mutate(Model = factor(Model, levels = custom_order)) %>%
    arrange(Model) %>%
    mutate(AIC = ifelse(Model == "Clinical", 
                        round(clinical_aic, 3), AIC)) %>%
    select(-R2c) %>%
    rename("RÂ²" = R2m, "P-Value" = `Pr(>Chisq)`) %>%
    mutate(across(c(`P-Value`, Significance), ~replace_na(., "-")))

  final_anova_table <- r2_annotated %>%
    gt() %>%
    tab_header(title = "Model Comparison (ANOVA)") %>%
    fmt_number(columns = where(is.numeric), decimals = 2) %>%
    sub_missing(missing_text = "-") %>%
    cols_align(align = "center", columns = everything()) %>%
    tab_options(table.width = pct(60), table.align = "center") %>%
    opt_table_font(font = list(google_font("Arial"), default_fonts())) %>%
    tab_style(style = cell_text(size = 14), locations = cells_body()) %>%
    tab_style(style = cell_text(size = 16, weight = "bold"), locations = cells_column_labels()) %>%
    tab_style(style = cell_text(size = 18, weight = "bold"), locations = cells_title())

  assign(paste0(omic_name, "_anova_table_clin_p"), final_anova_table)
  assign(paste0(omic_name, "_r2_annotated_clin_plus"), r2_annotated)
}
```

CLinical Anova plots 

```{r}
# For *_delta dataframes
delta_labels <- c(
  "Clinical" = "Δ Clinical",
  "Clinical + GRS" = "+ Δ GRS",
  "Clinical + Pathway" = "+ Δ Pathway",
  "Clinical + Taxa" = "+ Δ Taxa",
  "Clinical + Micom" = "+ Δ Micom",
  "Clinical + Metabolomics" = "+ Δ Metabolomics",
  "Clinical + Combined" = "+ Δ Combined")

# For *_long dataframes
long_labels <- c(
  "Clinical" = " Clinical",
  "Clinical + GRS" = "+ GRS",
  "Clinical + Pathway" = "+ Pathway",
  "Clinical + Taxa" = "+ Taxa",
  "Clinical + Micom" = "+ Micom",
  "Clinical + Metabolomics" = "+ Metabolomics",
  "Clinical + Combined" = "+ Combined")

for (omic_name in names(omic_dfs)) {
  r2_annotated <- get(paste0(omic_name, "_r2_annotated_clin_plus"))
  basic_r2 <- r2_annotated$`RÂ²`[r2_annotated$Model == "Clinical"]
  
  # Set custom model order
  custom_order <- c("Clinical", "Clinical + GRS", "Clinical + Pathway",
                    "Clinical + Taxa", "Clinical + Micom", 
                    "Clinical + Metabolomics", "Clinical + Combined")
  
  fill_vals <- setNames(sapply(custom_order, get_color_clin), custom_order)

  # Choose label set based on dataframe name
  label_set <- if (omic_name %in% c("gl_lasso_delta", "merf_delta")) {
    delta_labels
  } else if (omic_name %in% c("gl_lasso_long", "merf_long")) {
    long_labels
  } else {
    NULL  # fallback or throw warning if needed
  }
  r2_annotated <- r2_annotated %>%
  dplyr::mutate(Model = factor(Model, levels = custom_order))

  sig_plot <- ggplot(r2_annotated, aes(x = Model, y = `RÂ²`, fill = Model)) +
    geom_col(width = 0.7, color = "white", size = 0.5) +
    geom_text(aes(y = `RÂ²` + 0.036, label = Significance), size = 10, color = "black", fontface = "bold") +
    scale_y_continuous(limits = c(0, 0.72), expand = expansion(mult = c(0, 0.1))) +
    scale_fill_manual(values = fill_vals) +
    scale_x_discrete(labels = label_set) +  
    #labs(title = glue("{omic_name_labels[[omic_name]]}"),
    labs(title = NULL,
         x = NULL,
         y = expression("Marginal " ~ R^2)) +
    combined_plot_theme(base_size = 20)
  
  print(sig_plot)
  assign(paste0(omic_name, "_sig_plot_clin_plus"), sig_plot)
}
```


Clinical ANOVAs GT tables 
```{r}
# Assuming you saved the cleaned data frames *before* turning them into gt tables:
all_anova_clean_tables_clin_p <- list(
  merf_long    = merf_long_anova_table_clin_p,
  gl_lasso_long = gl_lasso_long_anova_table_clin_p,
  merf_delta    = merf_delta_anova_table_clin_p,
  gl_lasso_delta = gl_lasso_delta_anova_table_clin_p)

raw_tables_clin_p <- lapply(all_anova_clean_tables_clin_p, 
                            function(gt_obj) gt_obj[["_data"]])

combined_anova_df_clin_p <- bind_rows(
  lapply(names(raw_tables_clin_p), function(name) {
    df <- raw_tables_clin_p[[name]]
    df$Model_Type <- name
    df
    }),
  .id = "Source")

# Step 1: Prepare and clean data
combined_anova_df_clin_p <- combined_anova_df_clin_p %>%
  dplyr::mutate(Model_Type = case_when(
    Model_Type == "merf_long"      ~ "D. MERF BMI prediction",
    Model_Type == "gl_lasso_long"  ~ "B. GlmmLasso BMI Prediction",
    Model_Type == "merf_delta"     ~ "C. MERF ΔBMI Prediction",
    Model_Type == "gl_lasso_delta" ~ "A. GlmmLasso ΔBMI Prediction",
    TRUE ~ Model_Type))

table_data_clin_p <- combined_anova_df_clin_p %>%
  dplyr::select(-Source) %>%
  arrange(Model_Type) %>%
  dplyr::mutate(across(where(is.numeric), ~ round(.x, 3))) %>%
  dplyr::select(-Model_Type)

# Split by model type
tables_clin_p <- split(table_data_clin_p, combined_anova_df_clin_p$Model_Type)

# Combined ANOVA table
final_anova_table_clin_p2 <- combined_anova_df_clin_p %>% 
  dplyr::select(-c("Source")) %>% 
  mutate(Model_Type = dplyr::case_when(
    Model_Type == "merf_long" ~ "MERF BMI Prediction",
    Model_Type == "gl_lasso_long" ~ "GlmmLasso BMI Prediction",
    Model_Type == "merf_delta" ~ "MERF ΔBMI Prediction",
    Model_Type == "gl_lasso_delta" ~ "GlmmLasso ΔBMI Prediction",
    TRUE ~ Model_Type)) %>% 
  gt(groupname_col = "Model_Type") %>%
    tab_header(title = "Additive Model Comparison's (ANOVA)") %>%
    fmt_number(columns = where(is.numeric), decimals = 3) %>%
    sub_missing(missing_text = "-") %>%
    cols_width(1 ~ pct(16),
               `RÂ²` ~ pct(10), 
               Significance ~ pct(10),
               `P-Value` ~ pct(10), 
               AIC ~ pct(10), 
               Model_Type ~ pct(12)) %>%
    cols_align(align = "center",
      columns = everything()) %>% 
    cols_align("left", columns = Model) %>%
    tab_options(table.width = pct(90),
                table.align = "center") %>%
    opt_table_font(font = list(
        google_font("Arial"),   # fallback to system font if unavailable
        default_fonts())) %>%
    tab_style(style = cell_text(weight = "bold"),
              locations = cells_column_labels()) %>% 
  tab_style(style = list(
    cell_fill(color = "lightgray"),
    cell_text(weight = "bold",
              size = 12)),
  locations = cells_row_groups())

final_anova_table_clin_p2
gtsave(final_anova_table_clin_p2, filename = paste0(omic_out_dir, "/anova_tables/anova_table_clin_p.png"))
```

# ANOVA TABLE FOR CLINICAL ANOVA COMBINED 

```{r}
create_word_doc(tables_clin_p, "anova_clinical_combined.docx")
```


# with % increase 
```{r}
# Function to add % RÂ² Increase column
add_r2_increase <- function(tbl) {
  base_r2 <- tbl$`RÂ²`[1]
  r2_increase <- c(NA, round(100 * (tbl$`RÂ²`[-1] - base_r2) / base_r2, 2))
  tibble::add_column(tbl, `% RÂ² Increase` = r2_increase, .after = "RÂ²")
}

# Create tables with RÂ² increase and save to Word document
tables_clin_p_plus <- lapply(tables_clin_p, add_r2_increase)
create_word_doc(tables_clin_p_plus, "anova_clinical_combined_with_increase.docx")
```


```{r}
# Define plot names for later use
plot_names <- glue("{names(omic_dfs)}_sig_plot")
plot_names_clin_plus <- glue("{names(omic_dfs)}_sig_plot_clin_plus")

```


################## FEATURE IMPORTANCES MERF #########################################

MERF feature importances

```{r echo=FALSE, fig.width = 6.5, fig.asp = 1.6, out.width="90%"}
merf_dfs_long <- list(Basic = basic, 
                      Clinical = meta, 
                      GRS = grs,
                      Taxa = taxa, 
                      Micom = micom, 
                      Pathway = pathway, 
                      Metabolomics = metabo, 
                      Combined = all)

merf_dfs_delta <- list(Basic = basic_md, 
                       Clinical = meta_md, 
                       GRS = grs_md, 
                       Taxa = taxa_md, 
                       Micom = micom_md, 
                       Pathway = pathway_md, 
                       Metabolomics = metabo_md, 
                       Combined = all_md)

# Combined feature sets
all_ft_dfs <- list(merf_lg = list(data = merf_dfs_long, 
                                  colors = ft_colors, 
                                  label = "MERF (Longitudinal BMI Prediction)", 
                                  model_label = "MERF (Longitudinal BMI Prediction)",
                                  x_ax_label = "Feature Importance"),
                   
                   merf_delta = list(data = merf_dfs_delta, 
                                     colors = ft_colors, 
                                     label = "MERF ΔBMI Prediction", 
                                     model_label = "MERF ΔBMI Prediction",
                                     x_ax_label = "Feature Importance"))

merf_plots <- list()
for (type in names(all_ft_dfs)) {
  ft_set <- all_ft_dfs[[type]]$data
  color_map <- all_ft_dfs[[type]]$colors
  label <- all_ft_dfs[[type]]$label
  model_label <- all_ft_dfs[[type]]$model_label  # "MERF" or "GlmmLasso"
  x_ax_label <- all_ft_dfs[[type]]$x_ax_label
  
  output_dir <- file.path(omic_out_dir, paste0("ft_imp_", model_label, "_", label))
  dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
  
  for (ft_name in names(ft_set)) {
    omic <- ft_set[[ft_name]]
    
    omic_parsed <- omic %>%
      mutate(Top_15_Feature_Importances = gsub("'", '"', Top_15_Feature_Importances)) %>%
      mutate(parsed = map(Top_15_Feature_Importances, fromJSON))
    
    omic_long <- omic_parsed %>%
      unnest(parsed) %>%
      dplyr::select(-Top_15_Feature_Importances) %>%
      dplyr::filter(Feature != "time") %>% 
      dplyr::filter(Model == "MSE Model")
    
    avg_importance <- omic_long %>%
      group_by(Feature) %>%
      summarise(avg_importance = mean(Importance, na.rm = TRUE), .groups = "drop") %>%
      slice_max(order_by = avg_importance, n = 10, with_ties = FALSE) %>%
      dplyr::filter(avg_importance != 0)
    
    avg_imp_name <- paste0("av_imp_", type, "_", ft_name, "_", label)
    assign(avg_imp_name, avg_importance, envir = .GlobalEnv)
    
    max_val <- max(avg_importance$avg_importance, na.rm = TRUE)
    x_limit <- ceiling(max_val / 0.05) * 0.05
 
    plot <- ggplot(avg_importance, aes(x = 0, y = reorder(Feature, avg_importance))) +
    geom_segment(aes(xend = avg_importance, 
                     yend = reorder(Feature, avg_importance)),
                     lineend = "round", linewidth = 12, 
                     color = color_map[[ft_name]]) +
    labs(title = paste(label, " ~ ",toupper(ft_name)),
       x = paste(" ", x_ax_label),
       y = NULL) +
    combined_plot_theme(base_size = 16) + 
    scale_x_continuous(limits = c(0, x_limit), 
                       expand = expansion(mult = c(0, 0.02))) 
    
    # Save to named R object and png
    object_name <- paste0("plot_", type, "_", ft_name, "_", label)
    assign(object_name, plot, envir = .GlobalEnv)
    merf_plots[[object_name]] <- plot
    png_name <- file.path(output_dir, paste0("feature_importance_", ft_name, "_", label, ".png"))
    ggsave(filename = png_name, plot = plot, width = 12, height = 5, dpi = 300)
  }
}
```


################## FEATURE IMPORTANCES GLMMLASSO #########################################

```{r echo=FALSE, fig.height=5, fig.width=7, out.width="100%"}

lass_dfs_long <- list(Basic = gl_ftimp_long_basic, 
                      Clinical = gl_ftimp_long_meta, 
                      GRS = gl_ftimp_long_grs,
                      Taxa = gl_ftimp_long_taxa, 
                      Micom = gl_ftimp_long_micom, 
                      Pathway = gl_ftimp_long_pathway, 
                      Metabolomics = gl_ftimp_long_metabo, 
                      Combined = gl_ftimp_long_all)

lass_dfs_delta <- list(Basic = gl_ftimp_delta_basic, 
                       Clinical = gl_ftimp_delta_meta, 
                       GRS = gl_ftimp_delta_grs,
                       Taxa = gl_ftimp_delta_taxa, 
                       Micom = gl_ftimp_delta_micom, 
                       Pathway = gl_ftimp_delta_pathway, 
                       Metabolomics = gl_ftimp_delta_metabo, 
                       Combined = gl_ftimp_delta_all)

# Combined feature sets
all_lass_ft_dfs <- list(lass_lg = list(data = lass_dfs_long, colors = ft_colors, 
                                  label = "long", 
                                  model_label = "GlmmLasso BMI Prediction",
                                  x_ax_label = "Feature Co-efficient"),
                        
                   lass_delta = list(data = lass_dfs_delta, colors = ft_colors, 
                                     label = "delta", 
                                     model_label = "GlmmLasso ΔBMI Prediction",
                                     x_ax_label = "Feature Co-efficient"))
imap_dfr(lass_dfs_long, ~ 
           summarise(.x, min = min(Estimate, na.rm = TRUE), max = max(Estimate, na.rm = TRUE)) %>%
           mutate(name = .y)) %>% bind_rows() %>% dplyr::select(name, min, max)

imap_dfr(lass_dfs_delta, ~ 
           summarise(.x, min = min(Estimate, na.rm = TRUE), max = max(Estimate, na.rm = TRUE)) %>%
           mutate(name = .y)) %>% bind_rows() %>% dplyr::select(name, min, max)

lass_plots_lg <- list()
lass_plots_delta <- list()

for (type in names(all_lass_ft_dfs)) {
  ft_set <- all_lass_ft_dfs[[type]]$data
  color_map <- all_lass_ft_dfs[[type]]$colors
  label <- all_lass_ft_dfs[[type]]$label
  model_label <- all_lass_ft_dfs[[type]]$model_label
  x_ax_label <- all_lass_ft_dfs[[type]]$x_ax_label

  for (ft_name in names(ft_set)) {
    top_features <- ft_set[[ft_name]]
    ymin <- -1.0
    ymax <- 1.1
    plot_feat <- top_features %>%
      dplyr::filter(!str_detect(tolower(Feature), "time")) %>%
      slice_head(n = 10) %>%
      dplyr::filter(Estimate != 0) %>%   
      mutate(Estimate_capped = pmin(pmax(Estimate, ymin), ymax))

    features <- ggplot(plot_feat,
       aes(x = 0,
           y = reorder(Feature, Estimate_capped))) +
      geom_segment(aes(xend = Estimate_capped,
                     yend = reorder(Feature, Estimate_capped)),
                 lineend = "round", linewidth = 12,
                 color = color_map[[ft_name]]) +
      labs(title = paste(model_label, toupper(ft_name)),
           y = NULL,
           x = paste("", x_ax_label)) +
      combined_plot_theme(base_size = 16) + 
      scale_y_discrete(expand = expansion(mult = c(0.05, 0.05)))

    object_name <- paste0("plot_", type, "_", ft_name, "_", label)
    assign(object_name, features, envir = .GlobalEnv)

    # Save to appropriate list
    if (type == "lass_lg") {
      lass_plots_lg[[ft_name]] <- features
    } else if (type == "lass_delta") {
      lass_plots_delta[[ft_name]] <- features
    }

    # PNG saving
    png_name <- file.path(omic_out_dir, "lass_ft_imp", 
                          paste0("feature_importance_", ft_name, "_", label, ".png"))
    ggsave(filename = png_name, plot = features, width = 9, height = 5, dpi = 300)
  }
}

```



### COMBINE ANOVA R2, MERF and GLMMLASSO plots ###

... now trying with patchwork

##### Basic Long 

```{r}
library(patchwork)
bl <- c(mget(plot_names[c(1,2)]), merf_plots[c(2, 3, 6, 7, 8)],  lass_plots_lg[c(2, 7)])
bl <- standardize_plot_theme(bl)

left_col <- (bl[[1]] / plot_spacer() / bl[[3]] / plot_spacer() / 
             bl[[4]] / plot_spacer() /  bl[[6]] / plot_spacer() / bl[[8]]) +
             plot_layout(heights = c(0.2, 0.02, 0.1, 0.02, 0.04, 0.02, 0.2, 0.02, 0.2))

right_col <- (bl[[2]] / plot_spacer() / bl[[5]] / plot_spacer() / 
              bl[[7]] / plot_spacer() / bl[[9]]) +
              plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.02, 0.2))

p <- (left_col | right_col) +
  plot_layout(widths = c(0.49, 0.49)) +
  plot_annotation(tag_levels = "A", tag_suffix = ".") &
  theme(plot.tag = element_text(face = "bold", size = 25),
        plot.tag.position = c(0.05, 0.97))

ggsave(file.path(omic_out_dir, "aov_feats_combined/basic_long_two_col_patchwork_spacers.png"),
       p, width = 40, height = 40, dpi = 400, bg = "white")
```


#### Basic Delta 

```{r}
bd <- c(mget(plot_names[c(3,4)]), merf_plots[c(10, 12, 15, 16)],  lass_plots_delta[c(2, 7)])
bd <- standardize_plot_theme(bd)

# Left column plots
left_col <- (bd[[1]] / plot_spacer() / bd[[3]] / plot_spacer() /
             bd[[6]] / plot_spacer() / bd[[8]]) + 
             plot_layout(heights = c(0.22, 0.02, 0.22, 0.02, 0.22, 0.02, 0.22))

# Right column plots
right_col <- (bd[[2]] / plot_spacer() / bd[[4]] / plot_spacer() /
              bd[[5]] / plot_spacer() / bd[[7]]) + 
              plot_layout(heights = c(0.215, 0.02, 0.215, 0.02, 0.215, 0.02, 0.215))

# Combine columns
pd <- (left_col | right_col) +
  plot_layout(widths = c(0.5, 0.45)) +
  plot_annotation(tag_levels = "A", tag_suffix = ".") + 
  theme(plot.tag = element_text(face = "bold", size = 25),
            plot.tag.position = c(0.05, 0.97))

# Save
ggsave(paste0(omic_out_dir, "/aov_feats_combined/basic_delta_test_patchwork.png"),
       pd, width = 40, height = 40, dpi = 400, bg = 'white')

```


##### Clinical Long 

```{r}
cl <- c(mget(plot_names_clin_plus[c(1,2)]), merf_plots[c(7, 8)],  lass_plots_lg[c(3,7)])
cl <- standardize_plot_theme(cl)

# Left column plots
left_col <- (cl[[1]] / plot_spacer() / cl[[3]] / plot_spacer() / cl[[6]] / plot_spacer()) + 
             plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.22))

# Right column plots
right_col <- (cl[[2]] / plot_spacer() / cl[[4]] / plot_spacer() / cl[[5]] / plot_spacer()) + 
              plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.22))

# Combine columns
cl <- (left_col | right_col) +
  plot_layout(widths = c(0.5, 0.45)) +
  plot_annotation(tag_levels = "A", tag_suffix = ".") + 
  theme(plot.tag = element_text(face = "bold", size = 25),
            plot.tag.position = c(0.05, 0.97))

ggsave(paste0(omic_out_dir, "/aov_feats_combined/clin_long_test_patchwork.png"), cl, 
       width = 40, height = 40, dpi = 400, bg = 'white')

```


##### Clinical Delta 

```{r}
cd <- c(mget(plot_names_clin_plus[c(3,4)]), merf_plots[c(12, 15, 16)],  lass_plots_delta[c(7)])
cd <- standardize_plot_theme(cd)

# Left column plots
left_col <- (cd[[1]] / plot_spacer() / cd[[3]] / plot_spacer() / cd[[6]] / plot_spacer()) + 
             plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.22))

# Right column plots
right_col <- (cd[[2]] / plot_spacer() / cd[[4]] / plot_spacer() / cd[[5]] / plot_spacer()) + 
              plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.22))

# Combine columns
cd <- (left_col | right_col) +
  plot_layout(widths = c(0.5, 0.45)) +
  plot_annotation(tag_levels = "A", tag_suffix = ".") + 
  theme(plot.tag = element_text(face = "bold", size = 25),
            plot.tag.position = c(0.05, 0.97))

ggsave(paste0(omic_out_dir, "/aov_feats_combined/clin_delta_test_patchwork.png"), cd, 
       width = 40, height = 40, dpi = 400, bg = 'white')
```

### Repeating with SHAP 

##### Basic Long SHAP

```{r}
library(patchwork)
bl <- c(mget(plot_names[c(1,2)]), shap_long_plot_list[c(2, 3, 6, 7, 8)],  lass_plots_lg[c(2, 7)])
bl <- standardize_plot_theme(bl)

left_col <- (bl[[1]] / plot_spacer() / bl[[3]] / plot_spacer() / 
             bl[[4]] / plot_spacer() /  bl[[6]] / plot_spacer() / bl[[8]]) +
             plot_layout(heights = c(0.2, 0.02, 0.1, 0.02, 0.04, 0.02, 0.2, 0.02, 0.2))

right_col <- (bl[[2]] / plot_spacer() / bl[[5]] / plot_spacer() / 
              bl[[7]] / plot_spacer() / bl[[9]]) +
              plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.02, 0.2))

p <- (left_col | right_col) +
  plot_layout(widths = c(0.48, 0.48)) +
  plot_annotation(tag_levels = "A", tag_suffix = ".") &
  theme(plot.tag = element_text(face = "bold", size = 25),
        plot.tag.position = c(0.05, 0.95))

ggsave(file.path(omic_out_dir, "aov_feats_combined/shap_basic_long_two_col_patchwork.png"),
       p, width = 40, height = 40, dpi = 400, bg = "white")
```


#### Basic Delta SHAP

```{r}
bd <- c(mget(plot_names[c(3,4)]), shap_delta_plot_list[c(2, 4, 7, 8)],  lass_plots_delta[c(2, 7, 8)])
bd <- standardize_plot_theme(bd)

# Left column plots
left_col <- (bd[[1]]/ plot_spacer()/ bd[[3]]/ plot_spacer()/ bd[[6]]/ plot_spacer()/
             bd[[8]]/ plot_spacer()) + 
             plot_layout(heights = c(0.22, 0.02, 0.2, 0.02, 0.2, 0.02, 0.25, 0.01))

# Right column plots
right_col <- (bd[[2]]/ plot_spacer()/ bd[[4]]/ plot_spacer()/ bd[[5]]/ plot_spacer()/ 
              bd[[7]]/ plot_spacer()/ bd[[9]]) + 
              plot_layout(heights = c(0.23, 0.02, 0.2, 0.02, 
                                      0.2, 0.02, 0.05, 0.015, 0.18))

# Combine columns
pd <- (left_col | right_col) +
  plot_layout(widths = c(0.48, 0.48)) +
  plot_annotation(tag_levels = "A", tag_suffix = ".") + 
  theme(plot.tag = element_text(face = "bold", size = 25),
        plot.tag.position = c(0.05, 0.95))

# Save
ggsave(paste0(omic_out_dir, "/aov_feats_combined/shap_basic_delta_test_patchwork.png"),
       pd, width = 40, height = 40, dpi = 400, bg = 'white')

```


##### Clinical Long SHAP

```{r}
cl <- c(mget(plot_names_clin_plus[c(1,2)]), shap_long_plot_list[c(7, 8)],  lass_plots_lg[c(3,7)])
cl <- standardize_plot_theme(cl)

# Left column plots
left_col <- (cl[[1]] / plot_spacer() / cl[[3]] / plot_spacer() / cl[[6]] / plot_spacer()) + 
             plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.25))

# Right column plots
right_col <- (cl[[2]] / plot_spacer() / cl[[4]] / plot_spacer() / cl[[5]] / plot_spacer()) + 
              plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.25))

# Combine columns
cl <- (left_col | right_col) +
  plot_layout(widths = c(0.48, 0.48)) +
  plot_annotation(tag_levels = "A", tag_suffix = ".") + 
  theme(plot.tag = element_text(face = "bold", size = 25),
            plot.tag.position = c(0.05, 0.95))

ggsave(paste0(omic_out_dir, "/aov_feats_combined/shap_clin_long_test_patchwork.png"), cl, 
       width = 40, height = 40, dpi = 400, bg = 'white')

```

##### Clinical Delta SHAP

```{r}
cd <- c(mget(plot_names_clin_plus[c(3,4)]), shap_delta_plot_list[c(7, 8)],  lass_plots_delta[c(3,7)])
cd <- standardize_plot_theme(cd)

# Left column plots
left_col <- (cd[[1]] / plot_spacer() / cd[[3]] / plot_spacer() / cd[[6]] / plot_spacer()) + 
             plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.25))

# Right column plots
right_col <- (cd[[2]] / plot_spacer() / cd[[4]] / plot_spacer() / cd[[5]] / plot_spacer()) + 
              plot_layout(heights = c(0.2, 0.02, 0.2, 0.02, 0.2, 0.25))

# Combine columns
cd <- (left_col | right_col) +
  plot_layout(widths = c(0.48, 0.48)) +
  plot_annotation(tag_levels = "A", tag_suffix = ".") + 
  theme(plot.tag = element_text(face = "bold", size = 25),
            plot.tag.position = c(0.55, 0.95))

ggsave(paste0(omic_out_dir, "/aov_feats_combined/shap_clin_delta_test_patchwork.png"), cd, 
       width = 40, height = 40, dpi = 400, bg = 'white')
```


## Heatmap

```{r echo=FALSE, fig.asp = 1.6, fig.width=7, out.width="100%"}
common_cols <- c("bmi", "y_new_basic", "y_new_grs",
                 "y_new_meta", "y_new_taxa", 
                 "y_new_micom", "y_new_pathway", 
                 "y_new_metabo", "y_new_all")

df_list_long <- list(merf_long = merf_long[common_cols],
                 gl_lasso_long = gl_lasso_long[common_cols])
df_list_delta <- list(merf_delta = merf_delta[common_cols],
                  gl_lasso_delta = gl_lasso_delta[common_cols])

# Step 1: Compute correlations for each dataframe
cor_matrices_long <- map(df_list_long, ~ cor(.x, use = "complete.obs"))
cor_matrices_delta <- map(df_list_delta, ~ cor(.x, use = "complete.obs"))

# Fix: Proper binding of melted correlation matrices
cor_long_df <- list(
  merf_long = reshape2::melt(cor_matrices_long$merf_long) %>% 
              mutate(method = "Merf", type = "Longitudinal BMI Scores"),
  gl_lasso_long = reshape2::melt(cor_matrices_long$gl_lasso_long) %>% 
                  mutate(method = "glmmLasso", type = "Longitudinal BMI Scores"),
  merf_delta = reshape2::melt(cor_matrices_delta$merf_delta) %>% 
               mutate(method = "Merf", type = "BMI Change Scores"),
  gl_lasso_delta = reshape2::melt(cor_matrices_delta$gl_lasso_delta) %>% 
                   mutate(method = "glmmLasso", type = "BMI Change Scores")) %>% 
  bind_rows() %>%
    mutate(Var1 = fct_recode(Var1,
                        "Actual BMI" = "bmi",
                        "Basic Score" = "y_new_basic",
                        "Meta Score" = "y_new_meta",
                        "GRS Score" = "y_new_grs",
                        "Taxa Score" = "y_new_taxa",
                        "Micom Score" = "y_new_micom",
                        "Pathway Score" = "y_new_pathway",
                        "Metabolomics Score" = "y_new_metabo",
                        "Combined Omic Score" = "y_new_all"),
      Var2 = fct_recode(Var2,
                        "Actual BMI" = "bmi",
                        "Basic Score" = "y_new_basic",
                        "Meta Score" = "y_new_meta",
                        "GRS Score" = "y_new_grs",
                        "Taxa Score" = "y_new_taxa",
                        "Micom Score" = "y_new_micom",
                        "Pathway Score" = "y_new_pathway",
                        "Metabolomics Score" = "y_new_metabo",
                        "Combined Omic Score" = "y_new_all"))

final_heat <- ggplot(cor_long_df, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  facet_grid(method ~ type) +
  scale_fill_gradient2(low = "#09236c", high = "#781720",
                       mid = "white", midpoint = 0.0,
                       limit = c(-0.3, 1), name = "Correlation") +
  theme_minimal(base_size = 16) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15),
        axis.text.y = element_text(size = 15), 
        strip.text = element_text(face = "bold", size = 16)) +
  labs(title = "Correlation Heatmaps: Long vs Delta", x = "", y = "")
```

```{r}
png_name <- file.path(omic_out_dir, paste0("final_heat_map_scores", ".png"))
ggsave(filename = png_name, plot = final_heat, width = 14, height = 10, dpi = 300)
```

```{r echo=FALSE, fig.asp = 0.75, fig.width=10, out.width="95%"}
final_heat
```

## bar plot instead of heatmap 

```{r}
rename_map <- c(
  "Actual BMI" = "bmi",
  "Basic Score" = "y_new_basic",
  "Clinical Score" = "y_new_meta",
  "GRS Score" = "y_new_grs",
  "Taxa Score" = "y_new_taxa",
  "Micom Score" = "y_new_micom",
  "Pathway Score" = "y_new_pathway",
  "Metabolomics Score" = "y_new_metabo",
  "Combined Omic Score" = "y_new_all")

score_colors <- c(
  "Basic Score" = ft_colors["Basic"],
  "Clinical Score" = ft_colors["Clinical"],
  "GRS Score" = ft_colors["GRS"],
  "Taxa Score" = ft_colors["Taxa"],
  "Micom Score" = ft_colors["Micom"],
  "Pathway Score" = ft_colors["Pathway"],
  "Metabolomics Score" = ft_colors["Metabolomics"],
  "Combined Omic Score" = ft_colors["Combined"],
  "Actual BMI" = "grey50")


merf_delta_bar <- merf_delta %>% rename(!!!rename_map) %>% 
                  filter(Time == 6)
merf_long_bar <- merf_long %>% rename(!!!rename_map) %>% 
                  filter(Time == 6)
gl_lasso_delta_bar <- gl_lasso_delta %>% rename(!!!rename_map) %>% 
                  filter(Time == 1)
gl_lasso_long_bar <- gl_lasso_long %>% rename(!!!rename_map) %>% 
                  filter(Time == 2)

# Consolidated function for plotting score means
plot_score_means <- function(df, title = "Mean Scores with Error Bars", y_limits = NULL) {
  summary_df <- df %>%
    select(`Basic Score`, `Clinical Score`, `GRS Score`, `Taxa Score`,
           `Micom Score`, `Pathway Score`, `Metabolomics Score`,  
           `Combined Omic Score`, `Actual BMI`) %>%
    pivot_longer(cols = everything(), 
                 names_to = "Score Type", 
                 values_to = "Value") %>%
    group_by(`Score Type`) %>%
    summarise(Mean = mean(Value, na.rm = TRUE),
              SE = sd(Value, na.rm = TRUE) / sqrt(n()),
              .groups = "drop")

  # Set desired order of bars
  score_levels <- c(
    "Actual BMI", "Basic Score", "Clinical Score",
    "GRS Score", "Taxa Score", "Micom Score",
    "Pathway Score", "Metabolomics Score", "Combined Omic Score"
  )
  summary_df$`Score Type` <- factor(summary_df$`Score Type`, levels = score_levels)

  # Create base plot
  p <- ggplot(summary_df, aes(x = `Score Type`, y = Mean, fill = `Score Type`)) +
    geom_col() +
    geom_errorbar(aes(ymin = Mean - SE, ymax = Mean + SE), width = 0.2) +
    scale_fill_manual(values = score_colors) +
    labs(x = NULL, y = "Mean Score", title = title) +
    theme_minimal(base_size = 14) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none")
  
  # Add y-axis limits if specified
  if (!is.null(y_limits)) {
    p <- p + coord_cartesian(ylim = y_limits)
  }
  
  return(p)
}

p10 <- plot_score_means(merf_delta_bar, title = "MERF Delta: Mean Scores Â± SE")
p20 <- plot_score_means(merf_long_bar, title = "MERF Long: Mean Scores Â± SE", y_limits = c(25, 34))
p30 <- plot_score_means(gl_lasso_delta_bar, title = "GLMM Delta: Mean Scores Â± SE")
p40 <- plot_score_means(gl_lasso_long_bar, title = "GLMM Long: Mean Scores Â± SE", y_limits = c(25, 34))

combined_raw_scores_plot <- (p10 | p20) / (p30 | p40)
ggsave(paste0(omic_out_dir, "score_means_grid.png"), 
       combined_raw_scores_plot, width = 12, height = 10, dpi = 300)

```


### Venn of features responsible for the top 50% of importance ? 

I'll need to rerun MERF for this. 

```{r}
# Function to extract top features from MERF data
get_top_features <- function(df, top_n = NULL, cum_percent = 0.5) {
  result <- df %>%
    mutate(Top_15_Feature_Importances = gsub("'", '"', Top_15_Feature_Importances)) %>%
    mutate(parsed = map(Top_15_Feature_Importances, fromJSON)) %>%
    unnest(parsed) %>%
    filter(Feature != "time") %>%
    group_by(Feature) %>%
    summarise(avg_importance = mean(Importance, na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(avg_importance))
  
  if (!is.null(top_n)) {
    result <- result %>% slice_head(n = top_n)
  } else {
    result <- result %>%
      mutate(
        cum_importance = cumsum(avg_importance),
        total_importance = sum(avg_importance),
        cum_percent = cum_importance / total_importance
      ) %>%
      filter(cum_percent <= cum_percent | row_number() == 1)
  }
  
  return(result %>% pull(Feature))
}

# Define omics and assign colors
omic_types <- c("basic", "meta", "taxa", "micom", "pathway", "metabo", "Combined")
venn_colors <- c("#d2495e", "#e9919c", "#5d2a3b", "#f1c28d", "#c0522d", "#f1cabb", "#872657")

# Output directory
venn_out_dir <- file.path(omic_out_dir, "venn_outputs")
dir.create(venn_out_dir, showWarnings = FALSE)

# Loop through each omic type
venn_plots_4_ <- list() 
for (i in seq_along(omic_types)) {
  omic <- omic_types[i]
  color <- venn_colors[i %% length(venn_colors) + 1]  # rotate if more omics than colors
  
  # Extract top 20 from GLMM
  top_glmm_lg <- get(paste0("gl_ftimp_long_", omic)) %>%
    arrange(desc(abs_estimate)) %>%
    #slice_head(n = 20) %>%
    pull(Feature)
  
  top_glmm_delta <- get(paste0("gl_ftimp_delta_", omic)) %>%
    arrange(desc(abs_estimate)) %>%
    #slice_head(n = 20) %>%
    pull(Feature)
  
  # Extract top 20 from MERF
  top_merf_lg <- get_top_features(get(omic), top_n = 20)
  top_merf_delta <- get_top_features(get(paste0(omic, "_md")), top_n = 20)
  
  # Prepare input
  venn_input <- list(
    `GLMM LG` = unique(top_glmm_lg),
    `GLMM DELTA` = unique(top_glmm_delta),
    `MERF LG` = unique(top_merf_lg),
    `MERF DELTA` = unique(top_merf_delta))
  
  # Generate Venn diagram
  venn_plot <- venn.diagram(
    x = venn_input,
    filename = NULL,
    fill = rep(color, 4),
    alpha = 0.5,
    cex = 0.9,
    cat.cex = 0.9,
    cat.fontfamily = "Arial",
    fontfamily = "Arial",
    cat.dist = c(0.3, 0.3, 0.20, 0.20),
    cat.pos = c(-26, 26, -20, 20),
    margin = 0.3)
  
  venn_plots_4_[[omic]] <- venn_plot
  
  # Save to file
  file_path <- file.path(venn_out_dir, paste0("venn_top50_", omic, ".png"))
  png(file_path, width = 1200, height = 1000, res = 300)
  
  grid.newpage()
  
  # Add title BEFORE drawing the Venn plot
  grid.text(
    paste("Overlap of ", toupper(omic), " Models Top Features"),
    x = 0.5, y = 0.90,                    # Centered and near the top
    gp = gpar(fontsize = 12, fontface = "bold", fontfamily = "Arial"),
    just = "center")
  
  # Draw Venn diagram
  grid.draw(venn_plot)
  
  dev.off()
}
```


#### Ven Diagram 

```{r echo=FALSE, fig.asp = 1.8, fig.width=10, out.width="80%"}
# Use the consolidated get_top_features function with top_n = 20

# Define omics and assign colors
omic_types <- c("basic", "meta", "taxa", "micom", "pathway", "metabo", "Combined")
venn_colors <- c("#d2495e", "#e9919c", "#5d2a3b", "#f1c28d", "#c0522d", "#f1cabb", "#872657")

# Output directory
venn_out_dir <- file.path(omic_out_dir, "venns")
dir.create(venn_out_dir, showWarnings = FALSE)

# Loop through each omic type
venn_plots_4_ <- list() 
for (i in seq_along(omic_types)) {
  omic <- omic_types[i]
  color <- venn_colors[i %% length(venn_colors) + 1]  # rotate if more omics than colors
  
  # Extract top 20 from GLMM
  top_glmm_lg <- get(paste0("gl_ftimp_long_", omic)) %>%
    arrange(desc(abs_estimate)) %>%
    slice_head(n = 20) %>%
    pull(Feature)
  
  top_glmm_delta <- get(paste0("gl_ftimp_delta_", omic)) %>%
    arrange(desc(abs_estimate)) %>%
    slice_head(n = 20) %>%
    pull(Feature)
  
  # Extract top 20 from MERF
  top_merf_lg <- get_top_features(get(omic), top_n = 20)
  top_merf_delta <- get_top_features(get(paste0(omic, "_md")), top_n = 20)
  
  # Prepare input
  venn_input <- list(
    `GLMM LG` = unique(top_glmm_lg),
    `GLMM DELTA` = unique(top_glmm_delta),
    `MERF LG` = unique(top_merf_lg),
    `MERF DELTA` = unique(top_merf_delta))
  
  # Generate Venn diagram
  venn_plot <- venn.diagram(
    x = venn_input,
    filename = NULL,
    fill = rep(color, 4),
    alpha = 0.5,
    cex = 0.9,
    cat.cex = 0.9,
    cat.fontfamily = "Arial",
    fontfamily = "Arial",
    cat.dist = c(0.3, 0.3, 0.20, 0.20),
    cat.pos = c(-26, 26, -20, 20),
    margin = 0.3)
  
  venn_plots_4_[[omic]] <- venn_plot
  
  # Save to file
  file_path <- file.path(omic_out_dir, paste0("venn_4set_", omic, ".png"))
  png(file_path, width = 1200, height = 1000, res = 300)
  
  grid.newpage()
  
  # Add title BEFORE drawing the Venn plot
  grid.text(
    paste("Overlap of ", toupper(omic), " Models Top Features"),
    x = 0.5, y = 0.90,                    # Centered and near the top
    gp = gpar(fontsize = 12, fontface = "bold", fontfamily = "Arial"),
    just = "center")
  
  # Draw Venn diagram
  grid.draw(venn_plot)
  
  dev.off()
}
```


```{r}
# Select omics to display
selected_omics <- c("meta", "taxa", "micom", "pathway", "metabo", "Combined")

display_names <- c(
  meta = "Clinical",
  taxa = "Taxa",
  micom = "Micom",
  pathway = "Pathway",
  metabo = "Metabolomics",
  all = "Combined"
)

# Build individual Venn + title grobs
venn_grobs <- lapply(selected_omics, function(omic) {
  display_name <- display_names[[omic]]  # Get mapped display name
  grobTree(
    grid.text(paste(toupper(display_name), "Models"),
              x = 0.5, y = 0.90,
              gp = gpar(fontsize = 12, fontface = "bold", fontfamily = "Arial")),
    venn_plots_4_[[omic]]
  )
})
# Create overall title as a grob
main_title <- textGrob(
  "Overlap of Top Feature Across Omic Models",
  gp = gpar(fontsize = 16, fontface = "bold", fontfamily = "Arial")
)

# Combine title and grid of plots
combined_plot <- arrangeGrob(
  do.call(arrangeGrob, c(venn_grobs, nrow = 2, ncol = 3)),
  top = main_title
)

# Draw on a new page
grid.newpage()
grid.draw(combined_plot)

file_path <- file.path(omic_out_dir, "venns/venn_grid_overall_title.png")
png(file_path, width = 3000, height = 2000, res = 300)
grid.draw(combined_plot)
dev.off()

```


```{r echo=FALSE, fig.asp = 1.2, fig.width=10, out.width="90%"}
g1 <- grobTree(venn_plots_4_$basic)
g2 <- grobTree(venn_plots_4_$meta)
g3 <- grobTree(venn_plots_4_$taxa)
g4 <- grobTree(venn_plots_4_$micom)
g5 <- grobTree(venn_plots_4_$metabo)
g6 <- grobTree(venn_plots_4_$all)

# Create a 2-column layout with 3 rows + spacers
p <- arrangeGrob(
  arrangeGrob(g1, g2, ncol = 2),
  spacer <- rectGrob(gp = gpar(col = NA)),
  arrangeGrob(g3, g4, ncol = 2),
  spacer,
  arrangeGrob(g5, g6, ncol = 2),
  ncol = 1,
  widths = unit(1, "null"),
  heights = unit.c(unit(1, "null"), unit(1.5, "cm"),
                   unit(1, "null"), unit(1.5, "cm"),
                   unit(1, "null")))

p <- arrangeGrob(
  arrangeGrob(g1, nullGrob(), g2, ncol = 3, widths = c(0.45, 0.1, 0.45)),
  rectGrob(gp = gpar(col = NA)),  # spacer row
  arrangeGrob(g3, nullGrob(), g4, ncol = 3, widths = c(0.45, 0.1, 0.45)),
  rectGrob(gp = gpar(col = NA)),  # spacer row
  arrangeGrob(g5, nullGrob(), g6, ncol = 3, widths = c(0.45, 0.1, 0.45)),
  ncol = 1,
  heights = unit.c(
    unit(1, "null"),
    unit(1.5, "cm"),
    unit(1, "null"),
    unit(1.5, "cm"),
    unit(1, "null")
  )
)
# Display in R Markdown
grid::grid.newpage()
grid::grid.draw(p)
```


```{r}
# Define file name
png_name <- file.path(omic_out_dir, "venns/venn_combined_plot.png")
# Save the arranged plot to a PNG file
png(filename = png_name, width = 2800, height = 2800, res = 300)
grid.draw(p)
dev.off()
```

# Old Below: 

### COMBINE ANOVA R2, MERF and GLMMLASSO plots ###

# For 4 figures set up ANOVA
```{r aov combined code1}
# ## Testing all at once 
# bl <- c(mget(plot_names[c(1,2)]), merf_plots[c(2, 3, 6, 7, 8)],  lass_plots_lg[c(2, 7)])
# 
# # Apply standardized theme to all plots
# bl <- standardize_plot_theme(bl)
# p <- ggdraw()
# p <- p +
#   draw_plot(bl[[1]], x = 0, y = 0.6+ 0.15, width = 0.48, height = 0.22) + #A
#   draw_plot(bl[[2]], x = 0, y = 0.4+ 0.15, width = 0.48, height = 0.22) + #B
#   
#   draw_plot(bl[[3]], x = 0.53, y = 0.8 + 0.04, width = 0.46, height = 0.13) + #E
#   draw_plot(bl[[4]], x = 0.55, y = 0.66 + 0.04, width = 0.44, height = 0.11) + #F
#   draw_plot(bl[[5]], x = 0.51, y = 0.44 + 0.04, width = 0.48, height = 0.19) + #G
#   draw_plot(bl[[6]], x = 0.51, y = 0.22 + 0.04, width = 0.48, height = 0.19) + #H
#   draw_plot(bl[[7]], x = 0.51, y = 0 + 0.04, width = 0.48, height = 0.19) + #I
#   
#   draw_plot(bl[[8]], x = 0.01, y = 0.2+ 0.1, width = 0.47, height = 0.22) +   #C
#   draw_plot(bl[[9]], x = 0.01, y = 0 + 0.04,   width = 0.47, height = 0.22) #D
#   
# labels <- c("A.", "B.", "C.", "D.", "E.", "F.", "G.", "H.", "I.")
# label_x <- c(0.01, 0.01, 0.01, 0.01, rep(0.51, 5))
# label_y <- c(0.6+0.15+0.22, 0.4+0.15+0.22, 
#              0.2+0.1+0.22, 0+0.05+0.22, 
#              0.6+0.15+0.23, 0.62+0.2,
#              0.67, 0.47, 
#              0+0.05+0.22)
# p <- p + draw_plot_label(label = labels, x = label_x, y = label_y,
#                          fontface = "bold", size = 25)
# 
# ggsave(paste0(omic_out_dir, "/aov_feats_combined/basic_long_test.png"), p, 
#        width = 40, height = 40, dpi = 500, bg = 'white')
# 
# # new way basic delta
# bd <- c(mget(plot_names[c(3,4)]), merf_plots[c(10, 12, 15, 16)],  lass_plots_delta[c(2, 7)])
# 
# # Apply standardized theme to all plots
# bd <- standardize_plot_theme(bd)
# pd <- ggdraw()
# pd <- pd +
#   draw_plot(bd[[1]], x = 0, y = 0.6+ 0.15, width = 0.5, height = 0.22) +
#   draw_plot(bd[[2]], x = 0, y = 0.4+ 0.15, width = 0.5, height = 0.22) +
#   draw_plot(bd[[7]], x = 0.01, y = 0.2+ 0.1, width = 0.5, height = 0.22) +   
#   draw_plot(bd[[8]], x = 0.01, y = 0 + 0.05,   width = 0.5, height = 0.22)   
# # Right side 
# right_ysd <- seq(0.7, 0, length.out = 4)  # y positions for 4 plots
# for (i in 1:4) {
#   pd <- pd + draw_plot(bd[[i+2]], x = 0.52, y = 0.05 + right_ysd[i], width = 0.4, height = 0.215)
# }
# labelsd <- c("A.", "B.", "C.", "D.", "E.", "F.", "G.", "H.")
# label_xd <- c(0.01, 0.01, 0.01, 0.01, rep(0.516, 4))
# label_yd <- c(0.6+0.15+0.22, 
#              0.4+0.15+0.22, 
#              0.2+0.1+0.22, 
#              0+0.05+0.22, 
#              right_ysd + 0.05 + 0.215)
# pd <- pd + draw_plot_label(label = labelsd, x = label_xd, y = label_yd,
#                            fontface = "bold", size = 25)
# 
# ggsave(paste0(omic_out_dir, "/aov_feats_combined/basic_delta_test.png"), pd, 
#        width = 40, height = 40, dpi = 500, bg = 'white')
# 
# # New way clinical long 
# cl <- c(mget(plot_names_clin_plus[c(1,2)]), merf_plots[c(7, 8)],  lass_plots_lg[c(3,7)])
# 
# # Apply standardized theme to all plots
# cl <- standardize_plot_theme(cl)
# p_cl <- ggdraw()
# p_cl <- p_cl +
#   draw_plot(cl[[1]], x = 0.01, y = 0.565, width = 0.47, height = 0.25) + # a
#   draw_plot(cl[[2]], x = 0.01, y = 0.30 , width = 0.47, height = 0.25) + # b
#   draw_plot(cl[[3]], x = 0.51, y = 0.565, width = 0.48, height = 0.23) + # c
#   draw_plot(cl[[4]], x = 0.51, y = 0.30, width = 0.48, height = 0.23) + #d
#   draw_plot(cl[[5]], x = 0.01, y = 0.05, width = 0.47, height = 0.23) +
#   draw_plot(cl[[6]], x = 0.51, y = 0.05, width = 0.48, height = 0.23) 
# 
# labelcl <- c("A.", "B.", "C.", "D.", "E.", "F.")
# label_xcl <- c(0.01, 0.01, 0.50, 0.50, 0.01, 0.50)
# label_ycl <- c(0.59 + 0.21, 0.32 + 0.22, 0.59 + 0.21, 0.32 + 0.22, 0.05 + 0.23, 0.05 + 0.23)
# p_cl <- p_cl + draw_plot_label(label = labelcl, x = label_xcl, y = label_ycl,
#                                fontface = "bold", size = 25)
# 
# ggsave(paste0(omic_out_dir, "/aov_feats_combined/clin_long_test.png"), p_cl, 
#        width = 40, height = 40, dpi = 500, bg = 'white')
# 
# # New way clinical delta 
# cd <- c(mget(plot_names_clin_plus[c(3,4)]), merf_plots[c(12, 15, 16)],  lass_plots_delta[c(7)])
# 
# # Apply standardized theme to all plots
# cd <- standardize_plot_theme(cd)
# p_cd <- ggdraw()
# p_cd <- p_cd +
#   draw_plot(cd[[1]], x = 0.01, y = 0.565, width = 0.47, height = 0.25) + # a
#   draw_plot(cd[[2]], x = 0.01, y = 0.30 , width = 0.47, height = 0.25) + # b
#   draw_plot(cd[[3]], x = 0.51, y = 0.565, width = 0.48, height = 0.23) + # c
#   draw_plot(cd[[4]], x = 0.51, y = 0.30, width = 0.48, height = 0.23) + #d
#   draw_plot(cd[[6]], x = 0.01, y = 0.05, width = 0.47, height = 0.23) +
#   draw_plot(cd[[5]], x = 0.51, y = 0.05, width = 0.48, height = 0.23) 
# 
# labelcd <- c("A.", "B.", "D.", "E.", "F.", "C.")
# label_xcd <- c(0.01, 0.01, 0.50, 0.50, 0.50, 0.01)
# label_ycd <- c(0.59 + 0.21, 0.32 + 0.22, 0.59 + 0.21, 0.32 + 0.22, 0.05 + 0.23, 0.05 + 0.23)
# p_cd <- p_cd + draw_plot_label(label = labelcd, x = label_xcd, y = label_ycd,
#                                fontface = "bold", size = 25)
# 
# ggsave(paste0(omic_out_dir, "/aov_feats_combined/clin_delta_test.png"), p_cd, 
#        width = 40, height = 40, dpi = 500, bg = 'white')
```

### Repeat and replace with SHAP MERF feature plots 

```{r aov combined code2}
# ## Testing all at once 
# bl <- c(mget(plot_names[c(1,2)]), shap_long_plot_list[c(2, 3, 5, 7, 8)],  lass_plots_lg[c(2, 7)])
# 
# # Apply standardized theme to all plots
# bl <- standardize_plot_theme(bl)
# p <- ggdraw()
# p <- p +
#   draw_plot(bl[[1]], x = 0, y = 0.6+ 0.15, width = 0.48, height = 0.22) + #A
#   draw_plot(bl[[2]], x = 0, y = 0.4+ 0.15, width = 0.48, height = 0.22) + #B
#   
#   draw_plot(bl[[3]], x = 0.53, y = 0.8 + 0.04, width = 0.46, height = 0.14) + #E
#   draw_plot(bl[[4]], x = 0.55, y = 0.66 + 0.04, width = 0.44, height = 0.12) + #F
#   draw_plot(bl[[5]], x = 0.51, y = 0.44 + 0.04, width = 0.48, height = 0.20) + #G
#   draw_plot(bl[[6]], x = 0.51, y = 0.22 + 0.04, width = 0.48, height = 0.20) + #H
#   draw_plot(bl[[7]], x = 0.51, y = 0 + 0.04, width = 0.48, height = 0.20) + #I
#   
#   draw_plot(bl[[8]], x = 0.01, y = 0.2+ 0.1, width = 0.47, height = 0.22) +   #C
#   draw_plot(bl[[9]], x = 0.01, y = 0 + 0.04,   width = 0.47, height = 0.22) #D
#   
# labels <- c("A.", "B.", "C.", "D.", "E.", "F.", "G.", "H.", "I.")
# label_x <- c(0.01, 0.01, 0.01, 0.01, rep(0.51, 5))
# label_y <- c(0.6+0.15+0.22, 0.4+0.15+0.22, 
#              0.2+0.1+0.22, 0+0.05+0.22, 
#              0.6+0.15+0.23, 0.62+0.2,
#              0.67, 0.47, 
#              0+0.05+0.22)
# p <- p + draw_plot_label(label = labels, x = label_x, y = label_y,
#                          fontface = "bold", size = 25)
# 
# ggsave(paste0(omic_out_dir, "aov_feats_combined/basic_long_shap_1col.png"), p, 
#        width = 40, height = 40, dpi = 500, bg = 'white')
# 
# # new way basic delta
# bd <- c(mget(plot_names[c(3,4)]), shap_delta_plot_list[c(2, 4, 7, 8)],  lass_plots_delta[c(2, 7)])
# 
# # Apply standardized theme to all plots
# bd <- standardize_plot_theme(bd)
# pd <- ggdraw()
# pd <- pd +
#   draw_plot(bd[[1]], x = 0, y = 0.6+ 0.15, width = 0.5, height = 0.22) +
#   draw_plot(bd[[2]], x = 0, y = 0.4+ 0.12, width = 0.5, height = 0.22) +
#   draw_plot(bd[[7]], x = 0.015, y = 0.2+ 0.15, width = 0.45, height = 0.15) +   
#   draw_plot(bd[[8]], x = 0.01, y = 0 + 0.05,   width = 0.5, height = 0.25)   
# # Right side 
# right_ysd <- seq(0.7, 0, length.out = 4)  # y positions for 4 plots
# for (i in 1:4) {
#   pd <- pd + draw_plot(bd[[i+2]], x = 0.52, y = 0.05 + right_ysd[i], 
#                        width = 0.48, height = 0.215)
# }
# labelsd <- c("A.", "B.", "C.", "D.", "E.", "F.", "G.", "H.")
# label_xd <- c(0.01, 0.01, 0.01, 0.01, rep(0.516, 4))
# label_yd <- c(0.6+0.15+0.22, 
#              0.4+0.15+0.22, 
#              0.2+0.1+0.22, 
#              0+0.1+0.22, 
#              right_ysd + 0.05 + 0.215)
# pd <- pd + draw_plot_label(label = labelsd, x = label_xd, y = label_yd,
#                            fontface = "bold", size = 25)
# 
# ggsave(paste0(omic_out_dir, "aov_feats_combined/basic_delta_shap_1col.png"), pd, 
#        width = 40, height = 40, dpi = 500, bg = 'white')
# 
# # New way clinical long 
# cl <- c(mget(plot_names_clin_plus[c(1,2)]), shap_long_plot_list[c(7, 8)],  lass_plots_lg[c(3,7)])
# 
# # Apply standardized theme to all plots
# cl <- standardize_plot_theme(cl)
# p_cl <- ggdraw()
# p_cl <- p_cl +
#   draw_plot(cl[[1]], x = 0.01, y = 0.565, width = 0.47, height = 0.25) + # a
#   draw_plot(cl[[2]], x = 0.01, y = 0.30 , width = 0.47, height = 0.25) + # b
#   draw_plot(cl[[3]], x = 0.51, y = 0.565, width = 0.48, height = 0.23) + # c
#   draw_plot(cl[[4]], x = 0.51, y = 0.30, width = 0.48, height = 0.23) + #d
#   draw_plot(cl[[5]], x = 0.01, y = 0.05, width = 0.47, height = 0.23) +
#   draw_plot(cl[[6]], x = 0.51, y = 0.05, width = 0.48, height = 0.23) 
# 
# labelcl <- c("A.", "B.", "C.", "D.", "E.", "F.")
# label_xcl <- c(0.01, 0.01, 0.50, 0.50, 0.01, 0.50)
# label_ycl <- c(0.59 + 0.21, 0.32 + 0.22, 0.59 + 0.21, 0.32 + 0.22, 0.05 + 0.23, 0.05 + 0.23)
# p_cl <- p_cl + draw_plot_label(label = labelcl, x = label_xcl, y = label_ycl,
#                                fontface = "bold", size = 25)
# 
# ggsave(paste0(omic_out_dir, "aov_feats_combined/clin_long_shap_1col.png"), p_cl, 
#        width = 40, height = 40, dpi = 500, bg = 'white')
# 
# # New way clinical delta 
# cd <- c(mget(plot_names_clin_plus[c(3,4)]), shap_delta_plot_list[c(4, 7, 8)],  lass_plots_delta[c(7)])
# 
# # Apply standardized theme to all plots
# cd <- standardize_plot_theme(cd)
# p_cd <- ggdraw()
# p_cd <- p_cd +
#   draw_plot(cd[[1]], x = 0.01, y = 0.565, width = 0.47, height = 0.25) + # a
#   draw_plot(cd[[2]], x = 0.01, y = 0.30 , width = 0.47, height = 0.25) + # b
#   draw_plot(cd[[3]], x = 0.51, y = 0.565, width = 0.48, height = 0.23) + # c
#   draw_plot(cd[[4]], x = 0.51, y = 0.30, width = 0.48, height = 0.23) + #d
#   draw_plot(cd[[6]], x = 0.01, y = 0.05, width = 0.47, height = 0.23) +
#   draw_plot(cd[[5]], x = 0.51, y = 0.05, width = 0.48, height = 0.23) 
# 
# labelcd <- c("A.", "B.", "D.", "E.", "F.", "C.")
# label_xcd <- c(0.01, 0.01, 0.50, 0.50, 0.50, 0.01)
# label_ycd <- c(0.59 + 0.21, 0.32 + 0.22, 0.59 + 0.21, 0.32 + 0.22, 0.05 + 0.23, 0.05 + 0.23)
# p_cd <- p_cd + draw_plot_label(label = labelcd, x = label_xcd, y = label_ycd,
#                                fontface = "bold", size = 25)
# 
# ggsave(paste0(omic_out_dir, "aov_feats_combined/clin_delta_shap_1col.png"), p_cd, 
#        width = 40, height = 40, dpi = 500, bg = 'white')

```

